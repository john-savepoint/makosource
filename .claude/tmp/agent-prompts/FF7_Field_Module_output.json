[{"type":"system","subtype":"hook_response","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"2e146b0f-b59c-4c9d-a4ac-fbaee0564dbb","hook_name":"SessionStart:Callback","hook_event":"SessionStart","stdout":"","stderr":""},{"type":"system","subtype":"hook_response","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"f8aae3ef-41d1-48a3-8315-fbd1da549c71","hook_name":"SessionStart:startup","hook_event":"SessionStart","stdout":"","stderr":"","exit_code":0},{"type":"system","subtype":"hook_response","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"61b6b36c-fee2-4526-af4e-36420a6e96d3","hook_name":"SessionStart:Callback","hook_event":"SessionStart","stdout":"","stderr":""},{"type":"system","subtype":"hook_response","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"9f3160fd-0705-4a44-9722-7fb666f64e28","hook_name":"SessionStart:startup","hook_event":"SessionStart","stdout":"inject-session-id.sh > injected session ID: 88731ce4-e57c-4a06-b73f-6569a7b9979e [source: startup]\n{\n  \"hookSpecificOutput\": {\n    \"hookEventName\": \"SessionStart\",\n    \"additionalContext\": \"**Session ID**: `88731ce4-e57c-4a06-b73f-6569a7b9979e`\\n\\nSession data stored at: `.claude/data/sessions/88731ce4-e57c-4a06-b73f-6569a7b9979e.json`\\n\"\n  }\n}\n","stderr":"","exit_code":0},{"type":"system","subtype":"hook_response","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"a87f4cc2-c83a-4555-a623-7a33a8495860","hook_name":"SessionStart:startup","hook_event":"SessionStart","stdout":"Claude-88731ce4 tracked in tmux ff70G-japanese-mod:60:%62\n","stderr":"","exit_code":0},{"type":"system","subtype":"hook_response","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"53b68527-5dac-4af5-8daf-877fc6f4e2f5","hook_name":"SessionStart:startup","hook_event":"SessionStart","stdout":"play-startup-sound.sh > ðŸŽ® playing startup sound [source: startup, session: 88731ce4...]\n","stderr":"","exit_code":0},{"type":"system","subtype":"hook_response","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"8d85ca79-767a-4406-9adb-f1f4bfc32ce6","hook_name":"SessionStart:startup","hook_event":"SessionStart","stdout":"inject-session-context.sh > Context injected: /Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod on main (100 untracked, 29 modified) [~1559 tokens]\n{\n  \"hookSpecificOutput\": {\n    \"hookEventName\": \"SessionStart\",\n    \"additionalContext\": \"# Session Start Dynamic Context\\n**Updated**: 2025-12-02 01:29:32 JST (Tuesday)\\n**ISO 8601**: 2025-12-01T16:29:32Z\\n\\n## Current Working Directory\\n`/Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod`\\n\\n\\n\\n## Git Repository Status\\n- **Current Branch**: `main`\\n- **Last Commit**: e278ee0 - docs: complete standardization of all 37 FF7 game engine documents (6 minutes ago)\\n- **Untracked Files**: 100\\n- **Remote**: makosource\\tgit@github.com:john-savepoint/makosource.git (fetch)\\n\\n## Project Directory Structure (JSON)\\n\\n**Algorithm**: Levenshtein similarity ratio + semantic pattern detection\\n**Exclusions**: .gitignore patterns + hardcoded common patterns (node_modules, .git, dist, build, coverage, __pycache__)\\n**Truncation**:\\n- Files with â‰¥50% name similarity grouped (e.g., `test1.ts`, `test2.ts` â†’ `+N`)\\n- Non-semantic patterns hidden (UUIDs, session IDs, hashes, logs, tmp files)\\n- Semantic files always preserved (package.json, tsconfig.json, README.md, src/*.ts)\\n- Max depth: 2-4 levels (adaptive based on size, targets <15k tokens)\\n\\n**Reading**: `\\\"f\\\":[\\\"file.ts\\\",\\\"+5\\\"]` = 1 shown file + 5 similar/non-semantic files hidden\\n**Critical**: Source files (`src/**/*.ts`) never truncated via similarity, only via depth limits\\n\\n```json\\n{\\\".claude\\\":{\\\"data\\\":{\\\"ff7-docs-context\\\":{\\\"f\\\":[\\\"agent_summaries.json\\\",\\\"document_categories.json\\\",\\\"+4\\\"]},\\\"sessions\\\":{\\\"f\\\":[\\\"0442c7ca-eff1-466c-93f8-f629ccf6ddfb.json\\\",\\\"0cc720b2-3ab5-42f5-9a3c-7c40de6aa93e.json\\\",\\\"+2\\\"]}},\\\"logs\\\":{\\\"f\\\":[\\\"bash-output.log\\\",\\\"skill-usage.log\\\"]},\\\"tmp\\\":{\\\"agent-prompts\\\":{\\\"f\\\":[\\\"FF7_Battle_Battle_Animation_PC_output.json\\\",\\\"FF7_Battle_Battle_Animation_PC_prompt.txt\\\",\\\"FF7_Kernel_Low_level_libraries_prompt.txt\\\",\\\"PSX_TIM_format_prompt.txt\\\",\\\"+70\\\"]}}},\\\"FF7-Japanese-Mod\\\":{\\\".claude\\\":{\\\"data\\\":{\\\"sessions\\\":{\\\"f\\\":[\\\"0ba935f5-efe0-457c-ad7e-c18f89cfba18.json\\\"]}}},\\\"f\\\":[\\\"Readme.txt\\\",\\\"mod.xml\\\"]},\\\"archive\\\":{\\\"character_tables_debug\\\":{\\\"debug_cells\\\":{\\\"f\\\":[\\\"inv_jafont_1_idx006_gxy6_0.png\\\",\\\"inv_jafont_1_idx116_gxy4_7.png\\\",\\\"+32\\\"]}},\\\"character_tables_pre-interactive\\\":{\\\"f\\\":[\\\"character_map.csv\\\",\\\"character_map.json\\\",\\\"mapping_discrepancies.csv\\\",\\\"ocr_confidence.json\\\",\\\"+4\\\"]},\\\"character_tables_verification\\\":{\\\"verification\\\":{\\\"f\\\":[\\\"jafont_1_comparison.png\\\",\\\"jafont_1_generated.png\\\",\\\"+16\\\"]},\\\"verification_topleft\\\":{\\\"f\\\":[\\\"jafont_1_comparison_topleft.png\\\",\\\"jafont_1_mangaocr_topleft.png\\\",\\\"+10\\\"]}},\\\"findings_legacy\\\":{\\\"f\\\":[\\\"FINDINGS.md\\\",\\\"FINDINGS.md.backup\\\",\\\"findings2.md\\\"]},\\\"scripts\\\":{\\\"f\\\":[\\\"compare_mappings.py\\\",\\\"debug_mangaocr_cells.py\\\",\\\"generate_accurate_charmap.py\\\",\\\"manga_ocr_mapper.py\\\",\\\"measure_actual_glyph_size.py\\\",\\\"reassemble_findings.py\\\",\\\"+10\\\"]},\\\"sharded\\\":{\\\"bible\\\":{},\\\"bible_sections\\\":{\\\"f\\\":[\\\"1-executive-mission-briefing.md\\\",\\\"10-advanced-feature-furigana-support.md\\\",\\\"11-testing-verification-protocol.md\\\",\\\"12-risk-mitigation-debugging-guide.md\\\",\\\"14-reference-materials-appendices.md\\\",\\\"2-architectural-overview-strategic-analysis.md\\\",\\\"4-asset-specifications-data-structures.md\\\",\\\"5-ffnx-codebase-architecture.md\\\",\\\"6-deep-dive-technical-constraints-solutions.md\\\",\\\"7-implementation-specification-c-modifications.md\\\",\\\"conclusion.md\\\",\\\"index.md\\\",\\\"+6\\\"]},\\\"findings\\\":{},\\\"findings_sections\\\":{\\\"f\\\":[\\\"00_INDEX.md\\\",\\\"01_executive_summary.md\\\",\\\"06_ff7_text_system_architecture.md\\\",\\\"12_potential_implementation_approaches.md\\\",\\\"13_required_modifications.md\\\",\\\"14_development_roadmap_considerations.md\\\",\\\"17_next_steps.md\\\",\\\"18_conclusion.md\\\",\\\"27_breakthrough_first_ever_ff7_japanese_character_table_created.md\\\",\\\"+21\\\"]},\\\"f\\\":[\\\"README.md\\\",\\\"shard_findings.py\\\"]},\\\"f\\\":[\\\"ARCHITECTURAL_RETROSPECTIVE.md\\\",\\\"SCRAPED_URLS.md\\\",\\\"TOOL_VERIFICATION_LOG.md\\\",\\\"UNSCRAPPED_URLS.md\\\"]},\\\"assets\\\":{\\\"character_mappings\\\":{\\\"interactive_viewer\\\":{\\\"f\\\":[\\\"all_textures_corrections.json\\\",\\\"jafont_1_corrections (1).json\\\",\\\"jafont_6_final.json\\\",\\\"+11\\\"]}}},\\\"docs\\\":{\\\"character_maps\\\":{\\\"f\\\":[\\\"JAFONT_CHARACTER_MAP.md\\\",\\\"ff7_complete_mapping_compact.csv\\\"]},\\\"recent\\\":{},\\\"reference\\\":{\\\"game_engine\\\":{\\\".claude\\\":{},\\\"comparisons\\\":{\\\"f\\\":[\\\"CRITICAL_DISCREPANCIES_REQUIRING_INVESTIGATION.md\\\",\\\"FF7_Battle_Battle_Animation_PC_vs_06_BATTLE_MODULE_analysis.md\\\",\\\"FF7_Battle_Battle_Field_vs_06_BATTLE_MODULE_analysis.md\\\",\\\"repomix-comparisons-markdown.md\\\",\\\"+36\\\"]},\\\"extracted_major_sections\\\":{\\\"f\\\":[\\\"00_HEADER_TOC.md\\\",\\\"01_HISTORY.md\\\",\\\"06_BATTLE_MODULE.md\\\",\\\"11_BUGS_AND_CREDITS.md\\\",\\\"+10\\\"]},\\\"final\\\":{\\\"f\\\":[\\\"FF7.md\\\",\\\"FF7_Chocobo_Breeding.md\\\",\\\"FF7_History.md\\\",\\\"FF7_Item_Materia_Reference.md\\\",\\\"+33\\\"]},\\\"final v2\\\":{\\\"f\\\":[\\\"FF7_Battle_Battle_Animation_PC.md\\\",\\\"FF7_Battle_Battle_Field.md\\\",\\\"FF7_Chocobo_Breeding.md\\\",\\\"FF7_Engine_basics.md\\\",\\\"+2\\\"]},\\\"images\\\":{\\\"f\\\":[\\\"Engine_parts.jpg\\\",\\\"Field_BackgroundVRAM.jpg\\\",\\\"Gears_img_3.jpg\\\",\\\"+25\\\"]},\\\"markdown\\\":{\\\"f\\\":[\\\"FF7.md\\\",\\\"FF7_Chocobo_Breeding.md\\\",\\\"FF7_History.md\\\",\\\"FF7_Item_Materia_Reference.md\\\",\\\"+32\\\"]},\\\"raw\\\":{\\\"f\\\":[\\\"FF7.mediawiki\\\",\\\"FF7_Battle_Battle_Field.mediawiki\\\",\\\"+30\\\"]},\\\"scripts\\\":{\\\"f\\\":[\\\"transform_savemap.py\\\"]},\\\"f\\\":[\\\"AGENT_COMPARISON_GUIDE.md\\\",\\\"ENHANCEMENT_PLAN.md\\\",\\\"FINAL_CONVERSION_PIPELINE.md\\\",\\\"Playstation Battle Model Format.md\\\",\\\"combine_files.sh\\\",\\\"copy-paste from ff7 wiki.md\\\",\\\"ff7 game engine_meta.json\\\",\\\"links to copy in order.txt\\\",\\\"move_toc_below_heading.py\\\",\\\"scraper.py\\\",\\\"+59\\\"]},\\\"f\\\":[\\\"AF3DN_ANALYSIS.md\\\",\\\"ARCHITECTURE_CLARIFICATION.md\\\",\\\"BEGINNER_GUIDE.md\\\",\\\"MULTI_LANGUAGE_FINDINGS.md\\\",\\\"TOOL_GUIDE.md\\\",\\\"VERIFICATION_FINDINGS_SESSION_11.md\\\"]},\\\"roadmap\\\":{\\\"f\\\":[\\\"FEATURE_ROADMAP.md\\\",\\\"FFNX_CROWDSOURCED_TRANSLATION_SPEC.md\\\"]},\\\"f\\\":[\\\"7TH_HEAVEN_DEVELOPER_GUIDE.md\\\",\\\"BUILD_ENVIRONMENT_SETUP.md\\\",\\\"DOCUMENTATION_UPDATE_PLAN.md\\\",\\\"FFNX_DEVELOPER_GUIDE.md\\\",\\\"PR737_files_summary.txt\\\",\\\"README.md\\\",\\\"To-do list for documentation.md\\\",\\\"masterfindings.md\\\",\\\"+11\\\"]},\\\"japanese-assets-extracted\\\":{\\\"mod-structure\\\":{},\\\"f\\\":[\\\"FFNx-japanese.toml\\\",\\\"README.md\\\",\\\"TRANSFER_CHECKLIST.md\\\",\\\"WINDOWS_INSTALLATION_GUIDE.md\\\"]},\\\"reference\\\":{\\\"repomix_snapshots\\\":{\\\"f\\\":[\\\"FFNx_repomix.md\\\"]}},\\\"scripts\\\":{\\\"f\\\":[\\\"AGENT_LAUNCHER_USAGE.md\\\",\\\"BUG_FIXES.md\\\",\\\"V2_CLEANUP_WORKFLOW.md\\\",\\\"cleanup_v2_parallel.sh\\\",\\\"extract_doc_context.py\\\",\\\"launch_standardization_agents.sh\\\"]},\\\"f\\\":[\\\"DOCUMENTATION_MAP.md\\\",\\\"README.md\\\",\\\"SIMPLE_INSTRUCTIONS.md\\\",\\\"claude.md\\\"]}\\n```\\n\\n## Tmux Environment\\n- **Session**: `ff70G-japanese-mod` (`$7`)\\n- **Window**: `claude-88731ce4` (`@60` / index: 10)\\n- **Pane**: `%62`\\n\\n---\\n*This context was automatically injected at session start to provide current state information.*\\n\"\n  }\n}\n","stderr":"","exit_code":0},{"type":"system","subtype":"init","cwd":"/Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","tools":["Task","Bash","Glob","Grep","ExitPlanMode","Read","Edit","Write","NotebookEdit","WebFetch","TodoWrite","WebSearch","BashOutput","KillShell","Skill","SlashCommand","EnterPlanMode","mcp__context7__resolve-library-id","mcp__context7__get-library-docs","mcp__tmux__list-sessions","mcp__tmux__find-session","mcp__tmux__list-windows","mcp__tmux__list-panes","mcp__tmux__capture-pane","mcp__tmux__create-session","mcp__tmux__create-window","mcp__tmux__execute-command","mcp__tmux__get-command-result","ListMcpResourcesTool","ReadMcpResourceTool","mcp__interactive-send-and-capture__send_and_capture","mcp__interactive-send-and-capture__capture_pane","mcp__interactive-send-and-capture__send_input","mcp__mcp-mermaid__generate_mermaid_diagram","mcp__brave-search__brave_web_search","mcp__brave-search__brave_local_search","mcp__firecrawl__firecrawl_scrape","mcp__firecrawl__firecrawl_map","mcp__firecrawl__firecrawl_search","mcp__firecrawl__firecrawl_crawl","mcp__firecrawl__firecrawl_check_crawl_status","mcp__firecrawl__firecrawl_extract"],"mcp_servers":[{"name":"fetch","status":"disabled"},{"name":"sequential-thinking","status":"disabled"},{"name":"filesystem","status":"disabled"},{"name":"shadcn-ui","status":"disabled"},{"name":"context7","status":"connected"},{"name":"tmux","status":"connected"},{"name":"serena","status":"disabled"},{"name":"interactive-send-and-capture","status":"connected"},{"name":"mcp-mermaid","status":"connected"},{"name":"chrome-devtools","status":"disabled"},{"name":"svelte","status":"disabled"},{"name":"brave-search","status":"connected"},{"name":"firecrawl","status":"connected"}],"model":"claude-opus-4-5-20251101","permissionMode":"acceptEdits","slash_commands":["claude-code-hook-builder","mermaid-diagram-writer","slash-command-builder","superpowers:brainstorm","superpowers:execute-plan","superpowers:write-plan","agent-sdk-dev:new-sdk-app","pr-review-toolkit:review-pr","commit-commands:clean_gone","commit-commands:commit-push-pr","commit-commands:commit","feature-dev:feature-dev","code-review:code-review","document-skills:xlsx","document-skills:docx","document-skills:pptx","document-skills:pdf","example-skills:skill-creator","example-skills:mcp-builder","example-skills:canvas-design","example-skills:algorithmic-art","example-skills:internal-comms","example-skills:webapp-testing","example-skills:artifacts-builder","example-skills:slack-gif-creator","example-skills:theme-factory","example-skills:brand-guidelines","superpowers:brainstorming","superpowers:condition-based-waiting","superpowers:defense-in-depth","superpowers:dispatching-parallel-agents","superpowers:executing-plans","superpowers:finishing-a-development-branch","superpowers:receiving-code-review","superpowers:requesting-code-review","superpowers:root-cause-tracing","superpowers:sharing-skills","superpowers:subagent-driven-development","superpowers:systematic-debugging","superpowers:test-driven-development","superpowers:testing-anti-patterns","superpowers:testing-skills-with-subagents","superpowers:using-git-worktrees","superpowers:using-superpowers","superpowers:verification-before-completion","superpowers:writing-plans","superpowers:writing-skills","developer-essentials:auth-implementation-patterns","developer-essentials:code-review-excellence","developer-essentials:debugging-strategies","developer-essentials:e2e-testing-patterns","developer-essentials:error-handling-patterns","developer-essentials:git-advanced-workflows","developer-essentials:monorepo-management","developer-essentials:sql-optimization-patterns","developer-essentials:git-advanced-workflows","developer-essentials:sql-optimization-patterns","developer-essentials:error-handling-patterns","developer-essentials:code-review-excellence","developer-essentials:e2e-testing-patterns","developer-essentials:auth-implementation-patterns","developer-essentials:debugging-strategies","developer-essentials:monorepo-management","compact","context","cost","init","pr-comments","release-notes","todos","review","security-review"],"apiKeySource":"none","claude_code_version":"2.0.55","output_style":"default","agents":["general-purpose","statusline-setup","Explore","Plan","claude-code-guide","superpowers:code-reviewer","agent-sdk-dev:agent-sdk-verifier-py","agent-sdk-dev:agent-sdk-verifier-ts","pr-review-toolkit:code-reviewer","pr-review-toolkit:code-simplifier","pr-review-toolkit:comment-analyzer","pr-review-toolkit:pr-test-analyzer","pr-review-toolkit:silent-failure-hunter","pr-review-toolkit:type-design-analyzer","feature-dev:code-architect","feature-dev:code-explorer","feature-dev:code-reviewer"],"skills":["claude-code-hook-builder","mermaid-diagram-writer","slash-command-builder","document-skills:xlsx","document-skills:docx","document-skills:pptx","document-skills:pdf","example-skills:skill-creator","example-skills:mcp-builder","example-skills:canvas-design","example-skills:algorithmic-art","example-skills:internal-comms","example-skills:webapp-testing","example-skills:artifacts-builder","example-skills:slack-gif-creator","example-skills:theme-factory","example-skills:brand-guidelines","superpowers:brainstorming","superpowers:condition-based-waiting","superpowers:defense-in-depth","superpowers:dispatching-parallel-agents","superpowers:executing-plans","superpowers:finishing-a-development-branch","superpowers:receiving-code-review","superpowers:requesting-code-review","superpowers:root-cause-tracing","superpowers:sharing-skills","superpowers:subagent-driven-development","superpowers:systematic-debugging","superpowers:test-driven-development","superpowers:testing-anti-patterns","superpowers:testing-skills-with-subagents","superpowers:using-git-worktrees","superpowers:using-superpowers","superpowers:verification-before-completion","superpowers:writing-plans","superpowers:writing-skills","developer-essentials:auth-implementation-patterns","developer-essentials:code-review-excellence","developer-essentials:debugging-strategies","developer-essentials:e2e-testing-patterns","developer-essentials:error-handling-patterns","developer-essentials:git-advanced-workflows","developer-essentials:monorepo-management","developer-essentials:sql-optimization-patterns","developer-essentials:git-advanced-workflows","developer-essentials:sql-optimization-patterns","developer-essentials:error-handling-patterns","developer-essentials:code-review-excellence","developer-essentials:e2e-testing-patterns","developer-essentials:auth-implementation-patterns","developer-essentials:debugging-strategies","developer-essentials:monorepo-management"],"plugins":[{"name":"document-skills","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/anthropic-agent-skills/"},{"name":"example-skills","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/anthropic-agent-skills/"},{"name":"superpowers","path":"/Users/johnzealand-doyle/.claude/plugins/cache/superpowers"},{"name":"agent-sdk-dev","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/claude-code-plugins/plugins/agent-sdk-dev"},{"name":"pr-review-toolkit","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/claude-code-plugins/plugins/pr-review-toolkit"},{"name":"commit-commands","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/claude-code-plugins/plugins/commit-commands"},{"name":"feature-dev","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/claude-code-plugins/plugins/feature-dev"},{"name":"security-guidance","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/claude-code-plugins/plugins/security-guidance"},{"name":"code-review","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/claude-code-plugins/plugins/code-review"},{"name":"developer-essentials","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/claude-code-workflows/plugins/developer-essentials"},{"name":"explanatory-output-style","path":"/Users/johnzealand-doyle/.claude/plugins/marketplaces/claude-code-plugins/plugins/explanatory-output-style"}],"uuid":"91a93e53-f5c8-4994-a679-56413dcc2a9a"},{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EqsGH2dJy2n4x2Af5YLzfg","type":"message","role":"assistant","content":[{"type":"text","text":"I'll transform FF7_Field_Module.md according to the comprehensive instructions. Let me start by reading the source file."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":35749,"cache_read_input_tokens":29953,"cache_creation":{"ephemeral_5m_input_tokens":35749,"ephemeral_1h_input_tokens":0},"output_tokens":129,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"cb724aab-a45f-48e0-bd3f-b44eec79ab5d"},{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EqsGH2dJy2n4x2Af5YLzfg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012aJtMS1wZN4KwGYwjDSsK4","name":"Read","input":{"file_path":"/Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod/docs/reference/game_engine/markdown/merged_with_pdf_content/FF7_Field_Module.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":35749,"cache_read_input_tokens":29953,"cache_creation":{"ephemeral_5m_input_tokens":35749,"ephemeral_1h_input_tokens":0},"output_tokens":129,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"bb34173d-b616-4f7e-b907-e41816a6a4ad"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012aJtMS1wZN4KwGYwjDSsK4","type":"tool_result","content":"     1â†’# FF7/Field Module {#ff7field_module}\n     2â†’\n     3â†’- [FF7/Field Module](#ff7field_module){#toc-ff7field_module}\n     4â†’  - [Important Files](#important_files){#toc-important_files}\n     5â†’  - [Field Overview](#field_overview){#toc-field_overview}\n     6â†’  - [Field Format (PC)](#field_format_pc){#toc-field_format_pc}\n     7â†’\n     8â†’\n     9â†’## Important Files {#important_files}\n    10â†’\n    11â†’|  PSX Version  |       PC Version       |\n    12â†’|:-------------:|:----------------------:|\n    13â†’| /FIELD/\\*.DAT | /DATA/FIELD/FLEVEL.LGP |\n    14â†’| /FIELD/\\*.MIM | /DATA/FIELD/FLEVEL.LGP |\n    15â†’| /FIELD/\\*.BSX |                        |\n    16â†’| /FIELD/\\*.BCX |  /DATA/FIELD/CHAR.LGP  |\n    17â†’\n    18â†’## Field Overview {#field_overview}\n    19â†’\n    20â†’The field module is the core of the game to which everything else is spawned. It is tied very closely with the kernel and contains many low-level calls to it. The field system also contains a self-contained bytecode language called commonly called \\\"Field Script\\\". The field module is responsible for the following:\n    21â†’\n    22â†’- The loading and parsing of the field files\n    23â†’- The display of the 2D background ands related special effects\n    24â†’- The display of 3D elements in the field such as the camera, perspective and and entities\n    25â†’- The running of the Field Script to display events and to get user input\n    26â†’- The on-demand loading of other modules when needed\n    27â†’\n    28â†’The Field module loads modular \\\"Field Files\\\". In the PC version, the Field File is a single file with nine sections. In the PSX version, there are three files with the same name but with different extensions that do the same thing. The three files are MIM (Mutiple Image Maps, or the backgrounds), DAT (Field Script Data), and BSX (3D data).\n    29â†’\n    30â†’<div class=\"thumb tright\">\n    31â†’<div class=\"thumbinner\" style=\"width: 182px\">\n    32â†’\n    33â†’![![](180px-Field_BackgroundVRAM.jpg \"180px-Field_BackgroundVRAM.jpg\")](Field_BackgroundVRAM.jpg \"180px-Field_BackgroundVRAM.jpg\")\n    34â†’\n    35â†’<div class=\"thumbcaption\">\n    36â†’\n    37â†’Snapshot of the PSX\\'s VRAM demonstrating the background field files in various stages of assembly.\n    38â†’\n    39â†’</div>\n    40â†’</div>\n    41â†’</div>\n    42â†’\n    43â†’The backgrounds are actually 16x16 blocks that are loaded into VRAM and then assembled into the video buffer every frame. The system allows for layers to obscure the 3D entities using a simple painter\\'s algorithm.\n    44â†’\n    45â†’In this particular field file, there are six cached sections of background data. Also notice the bright green patches that don\\'t show up in in the video buffer. This was to show where a lower layer of 2D data was to be covered by a higher layer. The bright green is for debug purposes. During development, if any bright green showed up, it meant that your upper layer had a \\\"hole\\\" in it that a 3D entity could be seen through.\n    46â†’\n    47â†’When the PSX version of FF7 is ran in higher resolutions via emulation with texture filtering on, often the lower layers will \\\"bleed\\\" outside the upper layer and make artifacts. This was also the reason why the field files were not re-rendered for the PC version of the game. It would of required \\\"re-cutting\\\" the layers again in the higher resolution.\n    48â†’\n    49â†’Another last thing to note is in the middle of the bottom texture cache there are a sea of eyes. These blink at random times and reflect the random blinking of the characters in the game.\n    50â†’\n    51â†’\\\n    52â†’\n    53â†’## Field Format (PC) {#field_format_pc}\n    54â†’\n    55â†’### General PC Field File Format {#general_pc_field_file_format}\n    56â†’\n    57â†’Field files are always found in FLEVEL.LGP. They are always [LZS](FF7/LZS_format \"LZS\"){.wikilink} compressed.\n    58â†’\n    59â†’The first two bytes of each (decompressed) field file are blank (zero). The next four bytes is an integer indicating how many sections are present in the file. Then a number of 4-byte integers follow, giving the starting offset for each section.\n    60â†’\n    61â†’All field files should contain 9 sections; it\\'s what FF7 expects.\n    62â†’\n    63â†’### PC Field File Header {#pc_field_file_header}\n    64â†’\n    65â†’<table>\n    66â†’<thead>\n    67â†’<tr>\n    68â†’<th><p>Offset</p></th>\n    69â†’<th><p>Size</p></th>\n    70â†’<th><p>Description</p></th>\n    71â†’<th><p>Section Data</p></th>\n    72â†’</tr>\n    73â†’</thead>\n    74â†’<tbody>\n    75â†’<tr>\n    76â†’<td><p>0x00</p></td>\n    77â†’<td><p>2 bytes</p></td>\n    78â†’<td><p>Blank</p></td>\n    79â†’<td><p>Always 0x00</p></td>\n    80â†’</tr>\n    81â†’<tr>\n    82â†’<td><p>0x02</p></td>\n    83â†’<td><p>4 bytes</p></td>\n    84â†’<td><p>Number of Sections</p></td>\n    85â†’<td><p>Always 0x0009</p></td>\n    86â†’</tr>\n    87â†’<tr>\n    88â†’<td><p>0x06</p></td>\n    89â†’<td><p>4 bytes</p></td>\n    90â†’<td><p>Pointer to Section 1</p></td>\n    91â†’<td><p><a href=\"FF7/Field/Field_Script\" class=\"wikilink\" title=\"Field Script &amp; Dialog\">Field Script &amp; Dialog</a></p></td>\n    92â†’</tr>\n    93â†’<tr>\n    94â†’<td><p>0x0A</p></td>\n    95â†’<td><p>4 bytes</p></td>\n    96â†’<td><p>Pointer to Section 2</p></td>\n    97â†’<td><p><a href=\"FF7/Field/Camera_Matrix\" class=\"wikilink\" title=\"Camera Matrix\">Camera Matrix</a></p></td>\n    98â†’</tr>\n    99â†’<tr>\n   100â†’<td><p>0x0E</p></td>\n   101â†’<td><p>4 bytes</p></td>\n   102â†’<td><p>Pointer to Section 3</p></td>\n   103â†’<td><p><a href=\"FF7/Field/Model_Loader\" class=\"wikilink\" title=\"Model Loader\">Model Loader</a></p></td>\n   104â†’</tr>\n   105â†’<tr>\n   106â†’<td><p>0x12</p></td>\n   107â†’<td><p>4 bytes</p></td>\n   108â†’<td><p>Pointer to Section 4</p></td>\n   109â†’<td><p><a href=\"FF7/Field/Palette\" class=\"wikilink\" title=\"Palette\">Palette</a></p></td>\n   110â†’</tr>\n   111â†’<tr>\n   112â†’<td><p>0x16</p></td>\n   113â†’<td><p>4 bytes</p></td>\n   114â†’<td><p>Pointer to Section 5</p></td>\n   115â†’<td><p><a href=\"FF7/Field/Walkmesh\" class=\"wikilink\" title=\"Walkmesh\">Walkmesh</a></p></td>\n   116â†’</tr>\n   117â†’<tr>\n   118â†’<td><p>0x1A</p></td>\n   119â†’<td><p>4 bytes</p></td>\n   120â†’<td><p>Pointer to Section 6</p></td>\n   121â†’<td><p><a href=\"FF7/Field_Module/DAT/Tile_Map\" class=\"wikilink\" title=\"TileMap\">TileMap</a> (Unused)</p></td>\n   122â†’</tr>\n   123â†’<tr>\n   124â†’<td><p>0x1E</p></td>\n   125â†’<td><p>4 bytes</p></td>\n   126â†’<td><p>Pointer to Section 7</p></td>\n   127â†’<td><p><a href=\"FF7/Field/Encounter\" class=\"wikilink\" title=\"Encounter\">Encounter</a></p></td>\n   128â†’</tr>\n   129â†’<tr>\n   130â†’<td><p>0x22</p></td>\n   131â†’<td><p>4 bytes</p></td>\n   132â†’<td><p>Pointer to Section 8</p></td>\n   133â†’<td><p><a href=\"FF7/Field/Triggers\" class=\"wikilink\" title=\"Triggers\">Triggers</a></p></td>\n   134â†’</tr>\n   135â†’<tr>\n   136â†’<td><p>0x26</p></td>\n   137â†’<td><p>4 bytes</p></td>\n   138â†’<td><p>Pointer to Section 9</p></td>\n   139â†’<td><p><a href=\"FF7/Field/Background\" class=\"wikilink\" title=\"Background\">Background</a></p></td>\n   140â†’</tr>\n   141â†’<tr>\n   142â†’<td><p>0x2A</p></td>\n   143â†’<td><p>4 bytes</p></td>\n   144â†’<td><p>Where Pointer to Section 1 points to</p></td>\n   145â†’<td><p>Length of Section 1</p></td>\n   146â†’</tr>\n   147â†’<tr>\n   148â†’<td><p>0x2E</p></td>\n   149â†’<td><p>Varies</p></td>\n   150â†’<td><p>Start of Section 1 data. Continues for the<br />\n   151â†’number of bytes specified in Section Length</p></td>\n   152â†’<td><p><em>See links above</em></p></td>\n   153â†’</tr>\n   154â†’</tbody>\n   155â†’</table>\n   156â†’\n   157â†’Each section generally starts with a four byte integer indicating the length of the section. You could just work this out by comparing offsets (how much space until the next section/end of file, etc) but FF7 stores the length at the start of the section anyway. After that the actual data follows. So the first bit of data for a section is actually 4 bytes after the point given in the section header (since the first four bytes are actually the length marker).\n   158â†’\n   159â†’To examine each section, please navigate using the links in the table above. For sections 3 and 8, there is some information on [the forum](http://forums.qhimm.com/index.php?topic=4358.msg58674#msg58674).\n   160â†’\n   161â†’## Field Format (PS1) {#field_format_ps1}\n   162â†’\n   163â†’### PSX DAT Format {#psx_dat_format}\n   164â†’\n   165â†’The PSX script is contained in the DAT file, it is compressed with [LZS compression](FF7/LZS_format \"LZS compression\"){.wikilink}. The first 4 bytes of the compressed DAT file is the length of the compressed data starting at address 0x4.\n   166â†’\n   167â†’The header for the DAT file (after it is decompressed), is 28 bytes in size (they are used in the PSX, it\\'s a list of 7 long word values which point to locations in PSX RAM). So for each of these sections are addressable by taking the first memory location subtracting it and adding 28.\n   168â†’\n   169â†’There are 7 sections each corresponding to the first 7 memory locations at the beginning of the file.\n   170â†’\n   171â†’<table>\n   172â†’<thead>\n   173â†’<tr>\n   174â†’<th style=\"text-align: center; background: rgb(0,155,0);\"><p>Section Name</p></th>\n   175â†’<th style=\"text-align: center; background: rgb(0,155,0);\"><p>Section Information</p></th>\n   176â†’</tr>\n   177â†’</thead>\n   178â†’<tbody>\n   179â†’<tr>\n   180â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Script\" class=\"wikilink\" title=\"Script\">Script</a></p></td>\n   181â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains conversations, save point interaction etc.</p></td>\n   182â†’</tr>\n   183â†’<tr>\n   184â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Walkmesh\" class=\"wikilink\" title=\"Walkmesh\">Walkmesh</a></p></td>\n   185â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains walkmesh triangles and access info.</p></td>\n   186â†’</tr>\n   187â†’<tr>\n   188â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field_Module/DAT/Tile_Map\" class=\"wikilink\" title=\"TileMap\">TileMap</a></p></td>\n   189â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains the information for the background, animation,<br />\n   190â†’and static scene objects.</p></td>\n   191â†’</tr>\n   192â†’<tr>\n   193â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Camera_Matrix\" class=\"wikilink\" title=\"Camera_Matrix\">Camera_Matrix</a></p></td>\n   194â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains camera info.</p></td>\n   195â†’</tr>\n   196â†’<tr>\n   197â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Triggers\" class=\"wikilink\" title=\"Triggers\">Triggers</a></p></td>\n   198â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains triggers, singles, gateways and so on.</p></td>\n   199â†’</tr>\n   200â†’<tr>\n   201â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Encounter\" class=\"wikilink\" title=\"Encounter\">Encounter</a></p></td>\n   202â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Battle Encounter information for location.</p></td>\n   203â†’</tr>\n   204â†’<tr>\n   205â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Models\" class=\"wikilink\" title=\"Models\">Models</a></p></td>\n   206â†’<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Some info about field models.</p></td>\n   207â†’</tr>\n   208â†’</tbody>\n   209â†’</table>\n   210â†’\n   211â†’### PSX MIM Format {#psx_mim_format}\n   212â†’\n   213â†’Part of the PSX background data is contained in the [MIM file](FF7/Field/MIMfile \"MIM file\"){.wikilink}, it is compressed with [LZS compression](FF7/LZS_format \"LZS compression\"){.wikilink}. It consists of palettes (256 color ones) and screen blocks. No data for locating the blocks on the screen is in this file. The MIM file is a truncated TIM file and contains the normal clut location height and width information. This information is directly loaded into the PSX video ram to be decoded by the field module.\n   214â†’\n   215â†’### PSX BSX Format {#psx_bsx_format}\n   216â†’\n   217â†’The Field models are contained in the [BSX file](FF7/Field/BSX \"BSX file\"){.wikilink}, it is compressed with [LZS compression](FF7/LZS_format \"LZS compression\"){.wikilink}. [FIELD.TDB](FF7/Field/FIELD.TDB \"FIELD.TDB\"){.wikilink} contains the textures for these models.\n   218â†’\n   219â†’### PSX BCX Format {#psx_bcx_format}\n   220â†’\n   221â†’The individual characters\\' field models are stored in [BCX files](FF7/Field/BCX \"BCX files\"){.wikilink}. Their textures are also in [FIELD.TDB](FF7/Field/FIELD.TDB \"FIELD.TDB\"){.wikilink}; they are compressed with [LZS compression](FF7/LZS_format \"LZS compression\"){.wikilink}.\n   222â†’\n   223â†’## Event Scripting {#event_scripting}\n   224â†’\n   225â†’Event scripting is handled via a series of script commands and entities spawned for the event. The exception to this is the battle event scripting. This is actually a little bit different. Please refer to the [Field Script](FF7/Field/Script \"Field Script\"){.wikilink} for more information.\n   226â†’\n   227â†’## Script commands {#script_commands}\n   228â†’\n   229â†’The event scripting language for FF7 has 246 commands that have a wide array of functions. For a complete listing of the commands, opcodes, arguments and descriptions, please refer to the [opcodes](FF7/Field/Script/Opcodes \"opcodes\"){.wikilink} section.\n   230â†’\n   231â†’## Movies\n   232â†’\n   233â†’Movies in FF7 are actually triggered from the [Field Script](FF7/Field/Script \"Field Script\"){.wikilink}. The [F8 PMVIE](FF7/Field/Script/Opcodes/F8_PMVIE \"F8 PMVIE\"){.wikilink} opcode is first used to set the movie for which the [F9 MOVIE](FF7/Field/Script/Opcodes/F9_MOVIE \"F9 MOVIE\"){.wikilink} opcode is used to play. It is important to remember the MOVIE ID may vary in the PS1 versionn depending on what disc you are on. The PC movies were encoded using the DUCK (goose?) format and are AVI video files.\n   234â†’\n   235â†’The PS1 movies were encoded using FMV Motion JPEG video files, for the playstation. These files cannot be decode or read directly from the CD disc media because of the Mode 2 format of the files. The files are encoded using ISO Mode 2 which means the sectors are 2302 bytes in length instead of 2048. The video files have interleaved audio (ADPCM format), between video frames and are 320x224 15fps. Video files that have no audio with it actually has empty sectors of space between video frames to prevent the extremely timing sensitive MDEC decoder in the playstation from locking up.\n   236â†’\n   237â†’[Cyberman](User:Cyberman \"Cyberman\"){.wikilink} 14:18, 30 Dec 2006 (CST)\n   238â†’\n   239â†’## The 3D Overlay {#the_3d_overlay}\n   240â†’\n   241â†’## Data Organization {#data_organization}\n   242â†’\n   243â†’## \\\"A\\\" Field Animation Files for PC by [Mirex](User:Mirex \"Mirex\"){.wikilink} (Edits by [Aali](User:Aali \"Aali\"){.wikilink}) {#a_field_animation_files_for_pc_by_mirex_edits_by_aali}\n   244â†’\n   245â†’Each animation file holds one character animation ( run, walk or some other). Some characters have more animation files. Animation is set of frames, in each frame are stored bone rotations.\n   246â†’\n   247â†’\\-- animation file contents \\--\n   248â†’\n   249â†’| Name   | Size in bytes         |\n   250â†’|--------|-----------------------|\n   251â†’| header | 36                    |\n   252â†’| frames | frames_count \\* frame |\n   253â†’\n   254â†’\\-- one frame, size is (bones \\* 12 + 12 + 12) \\--\n   255â†’\n   256â†’| Name             | Size                                  |\n   257â†’|------------------|---------------------------------------|\n   258â†’| root rotation    | 12 = 3 floats                         |\n   259â†’| root translation | 12 = 3 floats                         |\n   260â†’| rotations        | bones \\* 12 bytes = bones \\* 3 floats |\n   261â†’\n   262â†’header structure, 36 bytes\n   263â†’\n   264â†’```c\n   265â†’structÂ {\n   266â†’Â Â Â Â unsignedÂ int32Â version;\n   267â†’Â Â Â Â unsignedÂ int32Â frames_count;\n   268â†’Â Â Â Â unsignedÂ int32Â bones_count;\n   269â†’Â Â Â Â unsignedÂ charÂ rotation_order[3];\n   270â†’Â Â Â Â unsignedÂ charÂ unused;\n   271â†’Â Â Â Â unsignedÂ int32Â runtime_data[5];\n   272â†’}Â anim_head;\n   273â†’```\n   274â†’\n   275â†’I understand only two values from the header, \\'frames_count\\' which is number of animation frames and \\'bones_count\\' which is suprisingly number of animated bones.\n   276â†’\n   277â†’*version should always be 1 or FF7 will not load the file*\n   278â†’\n   279â†’*rotation order determines in which order rotations are applied, 0 means alpha rotation, 1 beta rotation and 2 gamma rotation.*\n   280â†’\n   281â†’*runtime data has no meaning in the animation file and is discarded on load*\n   282â†’\n   283â†’If you want to load all possible animations for the model (even animations of different models) then check if animation file has same number of bones as current model.\n   284â†’\n   285â†’Frame starts with the root rotations and root translations, followed by rotations for each bone. Rotations are stored as 3 floats (float is 4byte floating-point number).\n   286â†’\n   287â†’\n   288â†’---\n   289â†’\n   290â†’<!-- MERGE METADATA\n   291â†’Created: 2025-11-29 15:45 JST\n   292â†’Original File: FF7_Field_Module.md (293 lines)\n   293â†’Major Section: 05_FIELD_MODULE.md (2,645 lines)\n   294â†’Additions: 6 critical sections, ~600 lines\n   295â†’Images: 1 existing (updated path), 1 referenced but missing\n   296â†’Report: comparisons/FF7_Field_Module_vs_05_FIELD_MODULE_analysis.md\n   297â†’-->\n   298â†’\n   299â†’## MERGED CONTENT FROM MAJOR SECTION\n   300â†’\n   301â†’The following sections have been extracted from 05_FIELD_MODULE.md and added to expand the technical coverage of the Field Module documentation.\n   302â†’\n   303â†’---\n   304â†’\n   305â†’<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n   306â†’     Lines 74-107 (Section 1 Dialog and Event)\n   307â†’     Status: Content added verbatim from major section\n   308â†’     Images: None\n   309â†’-->\n   310â†’\n   311â†’#### **Section 1 Dialog and Event (Halkun, Lasyan, and Fice)**\n   312â†’\n   313â†’The First section holds the Field Script logic and Dialog data for that particular field file. The first section of the PSX DAT file (excluding the DAT header) and the data in this section are the same. A recap of the PSX DAT file format is later in this document.\n   314â†’\n   315â†’The data in this section also has a header with the following format.\n   316â†’\n   317â†’#### Section 1 Header\n   318â†’\n   319â†’```\n   320â†’struct FF7SCRIPTHEADER {\n   321â†’ u16 unknown1;\n   322â†’ char nEntities; // Number of entities\n   323â†’ u16 unknown2; // Always less than nEntities; possibly visible entities?\n   324â†’ u16 wStringOffset; // Offset to strings\n   325â†’ u16 nExtraOffsets; // An optional number of extra offsets... unknown\n   326â†’ u16 unknown4[4];\n   327â†’ char szCreator[8]; // Field creator (never shown)\n   328â†’ char szName[8]; // Field name (never shown)\n   329â†’ char szEntities[nEntities][8]; // Field entity names\n   330â†’ u32 dwExtraOffsets[nExtraOffsets]; // Said extra offsets... unknown\n   331â†’ u16 vEntityScripts[nEntities][32]; // Entity script entry points, or more\n   332â†’                                     // explicitly, subroutine offsets\n   333â†’};\n   334â†’```\n   335â†’\n   336â†’#### Event Script Subsection\n   337â†’\n   338â†’Here we have all of the pointers tables, one for each section. Pointers are 2 bytes length. Each table has a length of 64 bytes, which means a section can have 32 scripts max. Each pointer refers to the first command of the current script. The section number N begins at the offset header\\_length+N\\*64. Note: the only way to retrieve the length of a script is to subtract the position of the next script to the position of the current script.\n   339â†’\n   340â†’#### Dialog Subsection\n   341â†’\n   342â†’Right after the last script of the last section, we find the pointer's table of the dialogs. The first 2 bytes show the number of dialogs in the file, so you can deduct the length of the table: number\\_of\\_dialogs\\*2. After these 2 bytes we have the pointers for each dialog. Be aware that the pointers are relative to the table, which means you must add the position of the table to each pointer in order to find the right position of the dialog. The dialogs begin right after the table, and the code 255 means the end of the dialog.\n   343â†’\n   344â†’Note: some <<hidden>> dialogs are not referenced in the table!\n   345â†’\n   346â†’<!-- END EXTRACTION -->\n   347â†’\n   348â†’---\n   349â†’\n   350â†’<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n   351â†’     Lines 109-168 (Section 2 Camera Matrix)\n   352â†’     Status: Content added verbatim from major section\n   353â†’     Images: None\n   354â†’-->\n   355â†’\n   356â†’#### **Section 2 Camera Matrix (Kero)**\n   357â†’\n   358â†’This is yet to be completely understand, I am pretty sure that this is not exactly trash, since it is based on at least 300 changes of field files. It was pretty nasty, as you can imagine, first divide sections of field file, load section 2 into hexedit, change byte, save section 2, run .bat file that complete new field file with new section 2 and compress it. After that I always had to use ficedula lgp tools, awful, I am definitely going to program command line program for this, in gui i had to alway on original field file, click, replace, click instead of just adding line to .bat file. After that run ff7.exe, go to destinated location and observe what happened.\n   359â†’\n   360â†’I am working on program to load walkmesh along with camera matrix. I am pretty sure about vectors, after all, they are all same length and they are orthogonal, but i could misinterpret order of them, position of center is little uncertain and resize factor too. The program should help me to figure out these thing.\n   361â†’\n   362â†’#### Description of section 2 (field file) - camera\n   363â†’\n   364â†’Goal of this section is to define camera matrix. In fact it seems pretty simple. For camera matrix, you need vector for axis x, vector for axis y, vector for axis z and position of camera in world space. Vectors for axis x,y,z are defined in world space and in camera space are normally united.\n   365â†’\n   366â†’Example: You have axis x defined as vector (0.176,-0.512,0.840) but thats in the world space, in camera space it is just (1,0,0)\n   367â†’\n   368â†’- \\* Every offset is relative here, 00 is at the start of section 2 (after length indicator).\n   369â†’- \\* This will will be in the left handed coordinated system= x axis from left to right, y axis from bottom to top, z axis from near to far.\n   370â†’- \\* In here, I am changing signs so these vectors should be correct for file loaded right from section 5 walkmesh. While in walkmesh you don't change any signs, here I am changing them, so they will fit and if you use this article with unchanged values for walkmesh, you should get right image , same as in ff7. (FIXME: not yet true)\n   371â†’\n   372â†’This is an overview the camera data format.\n   373â†’\n   374â†’#### Section 2 Format\n   375â†’\n   376â†’| Offset | Size    | Description             |\n   377â†’|--------|---------|-------------------------|\n   378â†’| 0x00   | 6 bytes | Camera Vector X axis    |\n   379â†’| 0x06   | 6 bytes | Camera Vector Y axis    |\n   380â†’| 0x0C   | 6 bytes | Camera Vector Z axis    |\n   381â†’| 0x12   | 2 bytes | Unknown                 |\n   382â†’| 0x14   | 4 byes  | Camera Space X position |\n   383â†’| 0x18   | 4 bytes | Camera Space Y position |\n   384â†’| 0x1C   | 4 bytes | Camera Space Z position |\n   385â†’| 0x20   | 4 byes  | Unknown                 |\n   386â†’| 0x24   | 2 bytes | Zoom                    |\n   387â†’\n   388â†’How to get vectors for the axis:\n   389â†’\n   390â†’Vectors are stored right at the beginning of section 2.\n   391â†’\n   392â†’```\n   393â†’typedef struct {\n   394â†’S16 x;\n   395â†’S16 y;\n   396â†’S16 z;\n   397â†’} vector3s;\n   398â†’```\n   399â†’\n   400â†’You will load first vector for axis x (from offset 0 to 5), for axis y(6 to 11) and axis z (12-17). These values are in fixed point with multiply constant 4096. Length of vectors x,y and z is always 4096 (first vecsize is for x, then y and last z), thats make out multiplication constant. These vectors are also always ortognormal, as you can see in ORTO 1-2 (1=x,2-y,3=z) ORTO U-Vis scalar product of U and V. As you can see, very near zero (first value is without division of multi constant). Now you have three vectors, but they are not looking in correct direction, you have to change some signs. For each vector change sign of y and z values. Now these vectors should point in correct direction, same as in ff7.\n   401â†’\n   402â†’I am now suppose that you have vectors for axises loaded, each component of each vector was divided by 4096 (don't forget to store it in float) and you changed signs for component y and z. After vectors is one S16 number (from offset 18 to 19), same as z component of vector for z axis.\n   403â†’\n   404â†’Now you want to have position of center of the camera matrix. Get three S32 numbers for position of center (x from 20 to 23, y from 24-27 and z from 28-31). These number are not position of center in worlds pace, but they are position of center of camera space, defined in space, where position of center is in 0,0,0 and axis for vectors are the ones you read, but have opposite signs. You get center of camera matrix like this:\n   405â†’\n   406â†’```\n   407â†’// vx,vy,vz are axis you read, divided, y,z signs changed\n   408â†’// (tx,ty,tz) is position of camera matrix in world space\n   409â†’// ox,oy,oz are S32 numbers you read from offset 20 to 31\n   410â†’tx = -(ox*vx.x + oy*vy.x + oz*vz.x);\n   411â†’ty = -(ox*vx.y + oy*vy.y + oz*vz.y);\n   412â†’tz = -(ox*vx.z + oy*vy.z + oz*vz.z);\n   413â†’```\n   414â†’\n   415â†’After this is just blank U32 number, seems always zero and last, but not least the zoom (36-37) (don't know whether Signed or Unsigned). The bigger resize number is, the bigger is the model and walkmesh.\n   416â†’\n   417â†’<!-- END EXTRACTION -->\n   418â†’\n   419â†’---\n   420â†’\n   421â†’<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n   422â†’     Lines 170-204 (Section 4 Palette)\n   423â†’     Status: Content added verbatim from major section\n   424â†’     Images: None\n   425â†’-->\n   426â†’\n   427â†’#### **Section 4 Pallette (Terrence)**\n   428â†’\n   429â†’The following is an overview of the palette data\n   430â†’\n   431â†’#### Section 4 Palette Format\n   432â†’\n   433â†’| Offset | Size    | Description                               |\n   434â†’|--------|---------|-------------------------------------------|\n   435â†’| 0x00   | 2 bytes | Length (Repeat of previous length header) |\n   436â†’| 0x02   | 2 bytes | Unknown                                   |\n   437â†’| 0x04   | 1 byte  | Unknown (often blank)                     |\n   438â†’| 0x05   | 4 byes  | Number of colors in palette               |\n   439â†’| 0x09   | 1 byte  | Unknown (often blank)                     |\n   440â†’| 0x0A   | varies  | Palette data                              |\n   441â†’\n   442â†’After the first length indicator comes another integer, also indicating length. Useless, but it's there.\n   443â†’\n   444â†’Then there's one more integer; unknown purpose.\n   445â†’\n   446â†’Then one byte; unknown (blank often).\n   447â†’\n   448â†’Then a word; number of colors in the palette plus one. No idea why. You can work numcolors out from the section length, but FF7 stores it anyway; why add one? Dunno.\n   449â†’\n   450â†’One more byte; unknown (blank often).\n   451â†’\n   452â†’Then the actual palette data.\n   453â†’\n   454â†’Each palette entry is a 16-bit color. This is unusual - normally palettes store as high quality data as possible, usually 24/32 bit. However since FF7 only ever runs in 16 bit I guess there isn't much point storing any other kind of data. Actually, the data is 15-bit (5-bit Red, 5-bit Green, 5-bit Blue, and 1 mask bit).\n   455â†’\n   456â†’|              | Palette Data |   |   |   |   |   |   |      |      |   |   |   |   |   |   |\n   457â†’|--------------|--------------|---|---|---|---|---|---|------|------|---|---|---|---|---|---|\n   458â†’| Red<br>Green |              |   |   |   |   |   |   | Blue | Mask |   |   |   |   |   |   |\n   459â†’| r            | r            | r | r | r | g | g | g | g    | g    | b | b | b | b | b | m |\n   460â†’\n   461â†’That's it for the palette! Only other thing you need to know is, palettes generally contain a number of colors that's a multiple of 256. This is because the palette is split up into 256-color 'pages' internally. So the first color is page 0/color 0. Color 256 is page 1/color 0. Color 628 is page 2/color 116. You'll see why in the background section.\n   462â†’\n   463â†’<!-- END EXTRACTION -->\n   464â†’\n   465â†’---\n   466â†’\n   467â†’<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n   468â†’     Lines 206-254 (Section 5 Walkmesh)\n   469â†’     Status: Content added verbatim from major section\n   470â†’     Images: _page_80_Picture_0.jpeg (NOT FOUND - flagged for sourcing)\n   471â†’-->\n   472â†’\n   473â†’#### **Section 5 Walkmesh (Kero)**\n   474â†’\n   475â†’Every every offset is here relative, 00 is at the start of section 5 (after lenght indicator)\n   476â†’\n   477â†’Section 5 of field files is stored walkmesh. Walkmesh is mesh of polygons on which is character moving, it is telling engine for example how height it is and thanks to that PC can, for example, cross bridge with real feeling that in the middle he is on higher place than on both sides. It has very simple structure.\n   478â†’\n   479â†’#### Header\n   480â†’\n   481â†’---------\n   482â†’\n   483â†’Startofs 0x00\n   484â†’\n   485â†’Lenght 0x04\n   486â†’\n   487â†’Walkmesh doesn't have header, it as only one 4 bytes long unsigned int, called NoS (Number of sectors)\n   488â†’\n   489â†’## Sector pool\n   490â†’\n   491â†’```\n   492â†’--------------\n   493â†’Startofs 0x04\n   494â†’Lenght NoS*24\n   495â†’typedef struct {\n   496â†’short x,z,y,res; // short is 2 bytes long integer\n   497â†’} vertex_3s; // 3 short\n   498â†’typedef struct {\n   499â†’vertex_3d v[3];\n   500â†’} sect_t;\n   501â†’```\n   502â†’\n   503â†’In sector pool are sectors, in fact just triangles and its position. For each sector you have three vertex\\_3s. Just store them. It seems that res and z are very often same, but not always, I don't know why. It seems that all polygons are clockwise. I didnt check it, but it is probably in order to know wheather point is in triangle. If you give it in other direction, point will be detected outside if it is inside and vice versa. Nothing difficult\n   504â†’\n   505â†’## Access pool\n   506â†’\n   507â†’Startofs 0x04 + NoS\\*24 Lenght NoS\\*6 typedef { short acces1,acces2,acces3; } In access pool you have id of poly, you should go into if you cross line.\n   508â†’\n   509â†’acces1 is for line from vertex 0 to 1\n   510â†’\n   511â†’acces2 is for line from vertex 1 to 2\n   512â†’\n   513â†’acces3 is for line from vertex 2 to 0\n   514â†’\n   515â†’If acces1/2/3 is FFFF then you are not allowed to cross this line. Acces pool and sector pool are same size (NoT), so you will just use same index for both pools.\n   516â†’\n   517â†’If access don't translate you, it just says, you should be here, if you are not, then there is a problem. If you design polymesh where you cross line and access tells you that you should be in poly 12, but you are god know where then FF7 stops.\n   518â†’\n   519â†’**[IMAGE REFERENCE - MISSING FROM CURRENT DIRECTORY]** Walkmesh polygon diagram (originally _page_80_Picture_0.jpeg)\n   520â†’\n   521â†’<!-- END EXTRACTION -->\n   522â†’\n   523â†’---\n   524â†’\n   525â†’<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n   526â†’     Lines 256-277 (Section 7 Encounter Data)\n   527â†’     Status: Content added verbatim from major section\n   528â†’     Images: None\n   529â†’-->\n   530â†’\n   531â†’#### **Section 7 (Terrence)**\n   532â†’\n   533â†’As stated, Section 7 is the Encounter listing, and is generally 48 bytes long (not including the Length dword). I've not even started to decrpyt what the other bytes mean around there... I suspect encounter rates and other things. Each encounter is stored something like: xxxxxxxx yyyyyyxx, where the 'x's are the standard Battle ID we're familiar with, and the 'y's are something connected to that specific encounter. Encounters where you can get ambushed appear to be held seperately from the others, too, starting at... what... 0x14? Unsure.\n   534â†’\n   535â†’Anyhow, feel free to play with it. I remain disappointed that this has yielded no trace of Ho-chu in Ancient Forest... was hoping it would at least be some really rare battle or something....\n   536â†’\n   537â†’EDIT: Few more notes on the Encounters section.\n   538â†’\n   539â†’First, \\*EVERY\\* Field file's Encounter section is 48 bytes long (52 if you include the size). It's then split into definite partitions:\n   540â†’\n   541â†’0x00: Encounter Data 1, possibly enounter rate in 2nd bytes? (2 bytes) 0x02-0x0D: Encounter+Chance(?) bytes, as stated before. The total of the 'Chance(?)' bytes for this part always adds up to 64 if encounters are possible.\n   542â†’\n   543â†’0x0E-0x17: Secondary encounters. Sometimes blank, sometimes gaps. No clue on the chance bytes, or how it relates to previous data.\n   544â†’\n   545â†’0x18: Encounter Data 2, same setup as Encounter Data 1. Very often blank, no idea what this data is for.\n   546â†’\n   547â†’0x1A-0x25: Encounter+Chance(?) bytes for Encounter Data 2. Again, adds up to 64.\n   548â†’\n   549â†’0x26-0x2F: Secondary encounters for Encounter Data 2. Again, no idea what it's used for.\n   550â†’\n   551â†’To get more information, I'm going to have to go and start changing things, but thought you'd like an update on what I had for now.\n   552â†’\n   553â†’<!-- END EXTRACTION -->\n   554â†’\n   555â†’---\n   556â†’\n   557â†’<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n   558â†’     Lines 280-429 (Section 9 Background and Sprite Format)\n   559â†’     Status: Content added verbatim from major section\n   560â†’     Images: None\n   561â†’-->\n   562â†’\n   563â†’#### **Section 9 Background (Terrence)**\n   564â†’\n   565â†’Firstly, a number of variables.\n   566â†’\n   567â†’At offset \\$28, a Word = background width (BGWidth)\n   568â†’\n   569â†’At offset \\$2A, a Word = background height (BGHeight)\n   570â†’\n   571â†’At offset \\$2C, a Word = number of background sprites (NumBGSprites)\n   572â†’\n   573â†’At offset \\$32, the background sprite data. See below for format (each sprite is 52 bytes long)\n   574â†’\n   575â†’After the background sprite data, another \\$7 bytes, unknown purpose.\n   576â†’\n   577â†’Then (ie. at offset \\$32 + NumBGSprites\\*52 + \\$7) a Word = number of 2nd layer background sprites (NumBG2Sprites)\n   578â†’\n   579â†’Then another \\$12 bytes, unknown purpose.\n   580â†’\n   581â†’Then (ie. at offset \\$32 + NumBGSprites\\*52 + \\$1B) the background layer 2 sprite data. See below for format.\n   582â†’\n   583â†’Then another \\$3D bytes, unknown purpose.\n   584â†’\n   585â†’Then (ie. at offset \\$32 + NumBGSprites\\*52 + NumBG2Sprites\\*52 + \\$58) the raw image data.\n   586â†’\n   587â†’#### Background paradigm\n   588â†’\n   589â†’-------------------\n   590â†’\n   591â†’(It isn't \\*really\\* a paradigm, but it sounds impressive if you say it is.)\n   592â†’\n   593â†’FF7 stores its backgrounds in a rather complex format. Basically, you have the data split up into various sections:\n   594â†’\n   595â†’- 1) Palette. List of colours.\n   596â†’- 2) Background sprites, layers 1 and 2. Just references to other bits of data.\n   597â†’- 3) Raw image data. Palettized data (ie. \"grayscale\" if viewed directly).\n   598â†’\n   599â†’Each background sprite represents a 16x16 pixel block on the finished background. The sprite essentially contains the following information:\n   600â†’\n   601â†’- -\"Target\" block, ie. where on the background to draw this 16x16 square\n   602â†’- -\"Source\" block, ie. where on the raw image data to take the pixels from\n   603â†’- -Palette \"page\", ie. which 256-colour palette block to apply to the raw image data\n   604â†’\n   605â†’This is a very efficient way to store the image; on the one hand, it's in 16-bit colour, far better than just palettizing the whole image (ie. 256 colours over the \\*whole\\* background). On the other hand, each 16x16 pixel block takes much less space than if you'd stored it directly in 16-bit colour format. It isn't, however, easy to decode or (especially!) encode.\n   606â†’\n   607â†’Format of a background sprite:\n   608â†’\n   609â†’```\n   610â†’Type\n   611â†’ TFF7BgSprite = packed record\n   612â†’ ZZ1,X,Y: Smallint;\n   613â†’ ZZ2: Array[0..1] of Smallint;\n   614â†’ SrcX,SrcY: Smallint;\n   615â†’ ZZ3: Array[0..3] of Smallint;\n   616â†’ Pal: Smallint;\n   617â†’ Flags: Word;\n   618â†’ ZZ4: Array[0..2] of Smallint;\n   619â†’ Page,Sfx: Smallint;\n   620â†’ NA: Longint;\n   621â†’ ZZ5: Smallint;\n   622â†’ OffX,OffY: Longint;\n   623â†’ ZZ6: Smallint;\n   624â†’ end;\n   625â†’```\n   626â†’\n   627â†’ZZ1,2,3,4,5,6: Unknown data X,Y: Target position SrcX,SrcY: Source position\n   628â†’\n   629â†’Pal: Which palette page to use\n   630â†’\n   631â†’Flags: Indicate special effects ... not really understood properly.\n   632â†’\n   633â†’Page: Which image source page to use\n   634â†’\n   635â†’Sfx: More special effects?\n   636â†’\n   637â†’NA: Unknown OffX,OffY: Unknown\n   638â†’\n   639â†’The image source data is split up into 256x256 pixel pages; that's why as well as a source X and Y, you also have a source page\n   640â†’\n   641â†’(which 256x256 block to take data from). On the other hand, the destination background is stored as one big bitmap with no limits on size, so there, you just have a target X/Y position which can be used directly.\n   642â†’\n   643â†’Also, note that each source image data \"page\" is preceded by 6 bytes of header.\n   644â†’\n   645â†’So, say the raw image data starts at offset ImageData. Given a background sprite, the offset where that sprites data starts is:\n   646â†’\n   647â†’```\n   648â†’StartOffset := (Page shl 16) or ((SrcY shl 8) or SrcX) + (Page+1)*6;\n   649â†’this is equivalent to\n   650â†’```\n   651â†’\n   652â†’StartOffset := (Page \\* \\$FFFF) + (SrcY \\* \\$FF) + SrcX + (Page+1)\\*6;\n   653â†’\n   654â†’(Page shl 16), (Page\\*\\$FFFF): Each page takes up 256x256 = \\$FFFF bytes, so skip that many for each page.\n   655â†’\n   656â†’(SrcY shl 8), (SrcY\\*\\$FF): Each pixel row takes up 256 = \\$FF bytes, so skip that many to get to the right row.\n   657â†’\n   658â†’SrcX: Taken directly.\n   659â†’\n   660â†’(Page+1)\\*6: Skip 6 bytes of header per page. (Page+1) since even page 0 has 6 bytes preceding it.\n   661â†’\n   662â†’Incidentally, the shifts are used in preference to multiplication since shifting is more efficient. Shifting on a computer is equivalent to multiplying/dividing by 2, 4, 8, .....\n   663â†’\n   664â†’For the destination, note that you can use X/Y directly; however 0,0 \\*appears\\*, I \\*think\\*, to be at the image \\*centre\\*, not at the top/bottom left corner like with most programs.\n   665â†’\n   666â†’So, now you know:\n   667â†’\n   668â†’- -Where the raw image data for that sprite starts\n   669â†’- -Where you're drawing it to\n   670â†’- -Which palette page to use\n   671â†’\n   672â†’Now, you just copy the pixels across, filtering the palette into it. IE:\n   673â†’\n   674â†’Read a pixel from source image (one byte).\n   675â†’\n   676â†’Set current colour to that colour in palette.\n   677â†’\n   678â†’Draw onto target.\n   679â†’\n   680â†’So, if you read a byte = 55 from the source image, you'd draw colour 55 in the selected palette to the target bitmap.\n   681â†’\n   682â†’#### Other points\n   683â†’\n   684â†’------------\n   685â†’\n   686â†’Currently, Qhimms (and therefore mine too) source code doesn't draw a sprite if the Sfx is non-zero; this is because we don't understand what it does.\n   687â†’\n   688â†’All variables above (Page, Pal, X, Y) start from ZERO; palette page zero is the first one, page one is the next one, etc.\n   689â†’\n   690â†’The image data in FF7 palettes is stored in reverse order; ie. on Windows, data is stored Red first, then Green, then Blue. FF7\n   691â†’\n   692â†’stores it the opposite way around, so you need to exchange the red/blue data. Here's how I do it in Cosmo:\n   693â†’\n   694â†’```\n   695â†’ DCol := 0;\n   696â†’ DCol := DCol or ( (Col^ and $1F) shl 10 );\n   697â†’ DCol := DCol or (Col^ and $3E0);\n   698â†’ DCol := DCol or ( (Col^ and $7C00) shr 10);\n   699â†’```\n   700â†’\n   701â†’Converts Col, an FF7 colour, into DCol, a (16-bit) Delphi colour.\n   702â†’\n   703â†’The first background sprites are drawn \"behind\" the layer 2 sprites.\n   704â†’\n   705â†’Variable conventions; I'm using Delphi names, which are as follows:\n   706â†’\n   707â†’Byte: 8 bit, unsigned, integer Word: 16 bit, unsigned, integer Smallint: 16 bit, signed, integer Integer/Longint:32 bit, signed, integer\n   708â†’\n   709â†’(Unsigned = positive values only. Signed can hold positive or negative values).\n   710â†’\n   711â†’Also, whenever I use numbers with \\$ signs above, it means I'm using hex values (hexadecimal).\n   712â†’\n   713â†’----------------------------\n   714â†’\n   715â†’<!-- END EXTRACTION -->\n   716â†’\n   717â†’---\n   718â†’\n   719â†’<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n   720â†’     Lines 2514-2580 (Opcode Matrix and Command Definitions)\n   721â†’     Status: Content added verbatim from major section\n   722â†’     Images: None\n   723â†’-->\n   724â†’\n   725â†’#### Opcode Matrix\n   726â†’\n   727â†’|    | 00       | 01           | 02       | 03           | 04      | 05       | 06      | 07       | 08       | 09        | 0a     | 0b       | 0c       | 0d      | 0e     | 0f       |\n   728â†’|----|----------|--------------|----------|--------------|---------|----------|---------|----------|----------|-----------|--------|----------|----------|---------|--------|----------|\n   729â†’| 00 | RET      | REQ          | REQSW    | REQEW        | PREQ    | PRQSW    | PRQEW   | RETTO    | JOIN     | SPLIT     | SPTYE  | GTPYE    | ?0C?     | ?0D?    | DSKCG  | SPECIAL  |\n   730â†’| 10 | GotoNext | GotoNextLong | GotoPrev | GotoPrevLong | IfUByte | IfUByteL | IfSWord | IfSWordL | IfUSWord | IfUSWordL | Â­      | Â­        | ?1C?     | Â­       | Â­      | Â­        |\n   731â†’| 20 | MINIGAME | TUTOR        | BTMD2    | BTRLD        | wait    | NFADE    | BLINK   | BGMOVIE  | KAWAI    | KAWIW     | PMOVA  | SLIP     | BGPDH    | BGSCR   | WCLS   | WSIZW    |\n   732â†’| 30 | IFÂ­KEY   | IFÂ­KEYON     | IFÂ­KEYOF | UC           | PDIRA   | PTURA    | WSPCL   | WNUMB    | STTIM    | GOLD+     | GOLDÂ­  | CHGLD    | HMPMAX1  | HMPMAX2 | MHMMX  | HMPMAX3  |\n   733â†’| 40 | message  | MPARA        | MPRA2    | MPNAM        | Â­       | MP+      | Â­       | MPÂ­      | ASK      | MENU      | MENU2  | BTLTB    | Â­        | HP+     | Â­      | HP       |\n   734â†’| 50 | window   | WMOVE        | WMODE    | WREST        | WCLSE   | WROW     | GWCOL   | SWCOL    | STÂ­ITM   | DLÂ­ITM    | CKÂ­ITM | SMÂ­TRA   | DMÂ­TRA   | CMÂ­TRA  | SHAKE  | NOP      |\n   735â†’| 60 | MAPJUMP  | SCRLO        | SCRLC    | SCRLA        | SCR2D   | SCRCC    | SCR2DC  | SCRLW    | SCR2DL   | MPDSP     | VWOFT  | FADE     | FADEW    | IDLCK   | LSTMP  | SCRLP    |\n   736â†’| 70 | battle   | BTLON        | BTLMD    | PGTDR        | GETPC   | PXYZI    | PLUS!   | PLUS2!   | MINUS!   | MINUS2!   | INC!   | INC2!    | DEC!     | DEC2!   | TLKON  | RDMSD    |\n   737â†’| 80 | set byte | SETÂ­WORD     | BITÂ­ON   | BITÂ­OFF      | BITÂ­XOR | PLUS     | PLUS2   | MINUS    | MINUS2   | MUL       | MUL2   | DIV      | DIV2     | MOD     | MOD2   | AND      |\n   738â†’| 90 | AND2     | OR           | OR2      | XOR          | XOR2    | INC      | INC2    | DEC      | DEC2     | RANDOM    | LBYTE  | HBYTE    | 2BYTE    | SETX    | GETX   | SEARCHX  |\n   739â†’| a0 | PC       | CHAR         | DFANM    | ANIME1       | VISI    | XYZI     | XYI     | XYZ      | MOVE     | CMOVE     | MOVA   | TURA     | ANIMW    | FMOVE   | ANIME2 | ANIM!1   |\n   740â†’| b0 | CANIM1   | CANM!1       | MSPED    | DIR          | TURNGEN | TURN     | DIRA    | GETDIR   | GETAXY   | GETAI     | ANIM!2 | CANIM2   | CANM!2   | ASPED   | Â­      | CC       |\n   741â†’| c0 | JUMP     | AXYZ         | LADER    | OFST         | OFSTW   | TALKR    | SLIDR   | SOLID    | PRTYP    | PRTYM     | PRTYE  | IFÂ­PRTYQ | IFÂ­MEMBQ | MMB+Â­   | MMBLK  | MMBUK    |\n   742â†’| d0 | LINE     | LINON        | MPJPO    | SLINE        | SIN     | COS      | TLKR2   | SLDR2    | PMJMP    | PMJMP2    | AKAO2  | FCFIX    | CCANM    | ANIMB   | TURNW  | MPPAL    |\n   743â†’| e0 | BGON     | BGOFF        | BGROL    | BGROL2       | BGCLR   | STPAL    | LDPAL   | CPPA     | RTPAL    | ADPAL     | MPPAL2 | STPLS    | LDPLS    | CPPAL2  | RTPAL2 | ADPAL2   |\n   744â†’| f0 | MUSIC    | Sound        | AKAO     | MUSVT        | MUSVM   | MULCK    | BMUSC   | CHMPH    | PMVIE    | MOVIE     | MVIEF  | MVCAM    | FMUSC    | CMUSC   | CHMST  | GAMEOVER |\n   745â†’\n   746â†’#### Opcode Definitions\n   747â†’\n   748â†’| Opcode | Name |\n   749â†’|--------|------|\n   750â†’| 0x00   | RET  |\n   751â†’\n   752â†’Arguments: (none)\n   753â†’\n   754â†’Description: Returns control back to the standard program loop. Usually you can control the PC again after this point.\n   755â†’\n   756â†’| Opcode | Name |\n   757â†’|--------|------|\n   758â†’| 0x01   | REQ  |\n   759â†’\n   760â†’Arguments: (none)\n   761â†’\n   762â†’Description: Returns control back to the standard program loop. Usually you can control the PC again after this point.\n   763â†’\n   764â†’| Opcode    | Name       |\n   765â†’|-----------|------------|\n   766â†’| 0x30      | WINDOW     |\n   767â†’\n   768â†’Arguments:\n   769â†’- id=byte - Window ID\n   770â†’\n   771â†’Additional Parameters:\n   772â†’- X coordinate for the upper left hand corner\n   773â†’- X coordinate for the upper left hand corner\n   774â†’- Width of window in pixels\n   775â†’- Height of window in pixels\n   776â†’\n   777â†’Description: Initializes a windowpane. This does not display a window, but allows for a \"container\" for the commands ASK and MESSAGE to place text within. It is referenced by it's window ID\n   778â†’\n   779â†’| Opcode       | Name                                      |\n   780â†’|--------------|-------------------------------------------|\n   781â†’| 0x48         | ASK                                       |\n   782â†’\n   783â†’Arguments:\n   784â†’- unknown=byte - Unknown\n   785â†’- win=byte - Window ID to place data into\n   786â†’- mes=byte - Which dialog to display from dialog table\n   787â†’- 1st=byte - Which line is the first choice\n   788â†’- nth=byte - Which line is the last choice\n   789â†’- var=byte - Unknown\n   790â†’\n   791â†’Description: The ASK command opens a window with a set of choices to be picked with the \"selector finger\" (Yubi)\n   792â†’\n   793â†’<!-- END EXTRACTION -->\n   794â†’\n   795â†’---\n   796â†’\n   797â†’## Images\n   798â†’\n   799â†’![Field BackgroundVRAM](../images/Field_BackgroundVRAM.jpg)\n   800â†’\n   801â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"196b75b6-5b35-490b-be88-547315e97144","tool_use_result":{"type":"text","file":{"filePath":"/Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod/docs/reference/game_engine/markdown/merged_with_pdf_content/FF7_Field_Module.md","content":"# FF7/Field Module {#ff7field_module}\n\n- [FF7/Field Module](#ff7field_module){#toc-ff7field_module}\n  - [Important Files](#important_files){#toc-important_files}\n  - [Field Overview](#field_overview){#toc-field_overview}\n  - [Field Format (PC)](#field_format_pc){#toc-field_format_pc}\n\n\n## Important Files {#important_files}\n\n|  PSX Version  |       PC Version       |\n|:-------------:|:----------------------:|\n| /FIELD/\\*.DAT | /DATA/FIELD/FLEVEL.LGP |\n| /FIELD/\\*.MIM | /DATA/FIELD/FLEVEL.LGP |\n| /FIELD/\\*.BSX |                        |\n| /FIELD/\\*.BCX |  /DATA/FIELD/CHAR.LGP  |\n\n## Field Overview {#field_overview}\n\nThe field module is the core of the game to which everything else is spawned. It is tied very closely with the kernel and contains many low-level calls to it. The field system also contains a self-contained bytecode language called commonly called \\\"Field Script\\\". The field module is responsible for the following:\n\n- The loading and parsing of the field files\n- The display of the 2D background ands related special effects\n- The display of 3D elements in the field such as the camera, perspective and and entities\n- The running of the Field Script to display events and to get user input\n- The on-demand loading of other modules when needed\n\nThe Field module loads modular \\\"Field Files\\\". In the PC version, the Field File is a single file with nine sections. In the PSX version, there are three files with the same name but with different extensions that do the same thing. The three files are MIM (Mutiple Image Maps, or the backgrounds), DAT (Field Script Data), and BSX (3D data).\n\n<div class=\"thumb tright\">\n<div class=\"thumbinner\" style=\"width: 182px\">\n\n![![](180px-Field_BackgroundVRAM.jpg \"180px-Field_BackgroundVRAM.jpg\")](Field_BackgroundVRAM.jpg \"180px-Field_BackgroundVRAM.jpg\")\n\n<div class=\"thumbcaption\">\n\nSnapshot of the PSX\\'s VRAM demonstrating the background field files in various stages of assembly.\n\n</div>\n</div>\n</div>\n\nThe backgrounds are actually 16x16 blocks that are loaded into VRAM and then assembled into the video buffer every frame. The system allows for layers to obscure the 3D entities using a simple painter\\'s algorithm.\n\nIn this particular field file, there are six cached sections of background data. Also notice the bright green patches that don\\'t show up in in the video buffer. This was to show where a lower layer of 2D data was to be covered by a higher layer. The bright green is for debug purposes. During development, if any bright green showed up, it meant that your upper layer had a \\\"hole\\\" in it that a 3D entity could be seen through.\n\nWhen the PSX version of FF7 is ran in higher resolutions via emulation with texture filtering on, often the lower layers will \\\"bleed\\\" outside the upper layer and make artifacts. This was also the reason why the field files were not re-rendered for the PC version of the game. It would of required \\\"re-cutting\\\" the layers again in the higher resolution.\n\nAnother last thing to note is in the middle of the bottom texture cache there are a sea of eyes. These blink at random times and reflect the random blinking of the characters in the game.\n\n\\\n\n## Field Format (PC) {#field_format_pc}\n\n### General PC Field File Format {#general_pc_field_file_format}\n\nField files are always found in FLEVEL.LGP. They are always [LZS](FF7/LZS_format \"LZS\"){.wikilink} compressed.\n\nThe first two bytes of each (decompressed) field file are blank (zero). The next four bytes is an integer indicating how many sections are present in the file. Then a number of 4-byte integers follow, giving the starting offset for each section.\n\nAll field files should contain 9 sections; it\\'s what FF7 expects.\n\n### PC Field File Header {#pc_field_file_header}\n\n<table>\n<thead>\n<tr>\n<th><p>Offset</p></th>\n<th><p>Size</p></th>\n<th><p>Description</p></th>\n<th><p>Section Data</p></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><p>0x00</p></td>\n<td><p>2 bytes</p></td>\n<td><p>Blank</p></td>\n<td><p>Always 0x00</p></td>\n</tr>\n<tr>\n<td><p>0x02</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Number of Sections</p></td>\n<td><p>Always 0x0009</p></td>\n</tr>\n<tr>\n<td><p>0x06</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 1</p></td>\n<td><p><a href=\"FF7/Field/Field_Script\" class=\"wikilink\" title=\"Field Script &amp; Dialog\">Field Script &amp; Dialog</a></p></td>\n</tr>\n<tr>\n<td><p>0x0A</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 2</p></td>\n<td><p><a href=\"FF7/Field/Camera_Matrix\" class=\"wikilink\" title=\"Camera Matrix\">Camera Matrix</a></p></td>\n</tr>\n<tr>\n<td><p>0x0E</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 3</p></td>\n<td><p><a href=\"FF7/Field/Model_Loader\" class=\"wikilink\" title=\"Model Loader\">Model Loader</a></p></td>\n</tr>\n<tr>\n<td><p>0x12</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 4</p></td>\n<td><p><a href=\"FF7/Field/Palette\" class=\"wikilink\" title=\"Palette\">Palette</a></p></td>\n</tr>\n<tr>\n<td><p>0x16</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 5</p></td>\n<td><p><a href=\"FF7/Field/Walkmesh\" class=\"wikilink\" title=\"Walkmesh\">Walkmesh</a></p></td>\n</tr>\n<tr>\n<td><p>0x1A</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 6</p></td>\n<td><p><a href=\"FF7/Field_Module/DAT/Tile_Map\" class=\"wikilink\" title=\"TileMap\">TileMap</a> (Unused)</p></td>\n</tr>\n<tr>\n<td><p>0x1E</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 7</p></td>\n<td><p><a href=\"FF7/Field/Encounter\" class=\"wikilink\" title=\"Encounter\">Encounter</a></p></td>\n</tr>\n<tr>\n<td><p>0x22</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 8</p></td>\n<td><p><a href=\"FF7/Field/Triggers\" class=\"wikilink\" title=\"Triggers\">Triggers</a></p></td>\n</tr>\n<tr>\n<td><p>0x26</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 9</p></td>\n<td><p><a href=\"FF7/Field/Background\" class=\"wikilink\" title=\"Background\">Background</a></p></td>\n</tr>\n<tr>\n<td><p>0x2A</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Where Pointer to Section 1 points to</p></td>\n<td><p>Length of Section 1</p></td>\n</tr>\n<tr>\n<td><p>0x2E</p></td>\n<td><p>Varies</p></td>\n<td><p>Start of Section 1 data. Continues for the<br />\nnumber of bytes specified in Section Length</p></td>\n<td><p><em>See links above</em></p></td>\n</tr>\n</tbody>\n</table>\n\nEach section generally starts with a four byte integer indicating the length of the section. You could just work this out by comparing offsets (how much space until the next section/end of file, etc) but FF7 stores the length at the start of the section anyway. After that the actual data follows. So the first bit of data for a section is actually 4 bytes after the point given in the section header (since the first four bytes are actually the length marker).\n\nTo examine each section, please navigate using the links in the table above. For sections 3 and 8, there is some information on [the forum](http://forums.qhimm.com/index.php?topic=4358.msg58674#msg58674).\n\n## Field Format (PS1) {#field_format_ps1}\n\n### PSX DAT Format {#psx_dat_format}\n\nThe PSX script is contained in the DAT file, it is compressed with [LZS compression](FF7/LZS_format \"LZS compression\"){.wikilink}. The first 4 bytes of the compressed DAT file is the length of the compressed data starting at address 0x4.\n\nThe header for the DAT file (after it is decompressed), is 28 bytes in size (they are used in the PSX, it\\'s a list of 7 long word values which point to locations in PSX RAM). So for each of these sections are addressable by taking the first memory location subtracting it and adding 28.\n\nThere are 7 sections each corresponding to the first 7 memory locations at the beginning of the file.\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: center; background: rgb(0,155,0);\"><p>Section Name</p></th>\n<th style=\"text-align: center; background: rgb(0,155,0);\"><p>Section Information</p></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Script\" class=\"wikilink\" title=\"Script\">Script</a></p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains conversations, save point interaction etc.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Walkmesh\" class=\"wikilink\" title=\"Walkmesh\">Walkmesh</a></p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains walkmesh triangles and access info.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field_Module/DAT/Tile_Map\" class=\"wikilink\" title=\"TileMap\">TileMap</a></p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains the information for the background, animation,<br />\nand static scene objects.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Camera_Matrix\" class=\"wikilink\" title=\"Camera_Matrix\">Camera_Matrix</a></p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains camera info.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Triggers\" class=\"wikilink\" title=\"Triggers\">Triggers</a></p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains triggers, singles, gateways and so on.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Encounter\" class=\"wikilink\" title=\"Encounter\">Encounter</a></p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Battle Encounter information for location.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p><a href=\"FF7/Field/Models\" class=\"wikilink\" title=\"Models\">Models</a></p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Some info about field models.</p></td>\n</tr>\n</tbody>\n</table>\n\n### PSX MIM Format {#psx_mim_format}\n\nPart of the PSX background data is contained in the [MIM file](FF7/Field/MIMfile \"MIM file\"){.wikilink}, it is compressed with [LZS compression](FF7/LZS_format \"LZS compression\"){.wikilink}. It consists of palettes (256 color ones) and screen blocks. No data for locating the blocks on the screen is in this file. The MIM file is a truncated TIM file and contains the normal clut location height and width information. This information is directly loaded into the PSX video ram to be decoded by the field module.\n\n### PSX BSX Format {#psx_bsx_format}\n\nThe Field models are contained in the [BSX file](FF7/Field/BSX \"BSX file\"){.wikilink}, it is compressed with [LZS compression](FF7/LZS_format \"LZS compression\"){.wikilink}. [FIELD.TDB](FF7/Field/FIELD.TDB \"FIELD.TDB\"){.wikilink} contains the textures for these models.\n\n### PSX BCX Format {#psx_bcx_format}\n\nThe individual characters\\' field models are stored in [BCX files](FF7/Field/BCX \"BCX files\"){.wikilink}. Their textures are also in [FIELD.TDB](FF7/Field/FIELD.TDB \"FIELD.TDB\"){.wikilink}; they are compressed with [LZS compression](FF7/LZS_format \"LZS compression\"){.wikilink}.\n\n## Event Scripting {#event_scripting}\n\nEvent scripting is handled via a series of script commands and entities spawned for the event. The exception to this is the battle event scripting. This is actually a little bit different. Please refer to the [Field Script](FF7/Field/Script \"Field Script\"){.wikilink} for more information.\n\n## Script commands {#script_commands}\n\nThe event scripting language for FF7 has 246 commands that have a wide array of functions. For a complete listing of the commands, opcodes, arguments and descriptions, please refer to the [opcodes](FF7/Field/Script/Opcodes \"opcodes\"){.wikilink} section.\n\n## Movies\n\nMovies in FF7 are actually triggered from the [Field Script](FF7/Field/Script \"Field Script\"){.wikilink}. The [F8 PMVIE](FF7/Field/Script/Opcodes/F8_PMVIE \"F8 PMVIE\"){.wikilink} opcode is first used to set the movie for which the [F9 MOVIE](FF7/Field/Script/Opcodes/F9_MOVIE \"F9 MOVIE\"){.wikilink} opcode is used to play. It is important to remember the MOVIE ID may vary in the PS1 versionn depending on what disc you are on. The PC movies were encoded using the DUCK (goose?) format and are AVI video files.\n\nThe PS1 movies were encoded using FMV Motion JPEG video files, for the playstation. These files cannot be decode or read directly from the CD disc media because of the Mode 2 format of the files. The files are encoded using ISO Mode 2 which means the sectors are 2302 bytes in length instead of 2048. The video files have interleaved audio (ADPCM format), between video frames and are 320x224 15fps. Video files that have no audio with it actually has empty sectors of space between video frames to prevent the extremely timing sensitive MDEC decoder in the playstation from locking up.\n\n[Cyberman](User:Cyberman \"Cyberman\"){.wikilink} 14:18, 30 Dec 2006 (CST)\n\n## The 3D Overlay {#the_3d_overlay}\n\n## Data Organization {#data_organization}\n\n## \\\"A\\\" Field Animation Files for PC by [Mirex](User:Mirex \"Mirex\"){.wikilink} (Edits by [Aali](User:Aali \"Aali\"){.wikilink}) {#a_field_animation_files_for_pc_by_mirex_edits_by_aali}\n\nEach animation file holds one character animation ( run, walk or some other). Some characters have more animation files. Animation is set of frames, in each frame are stored bone rotations.\n\n\\-- animation file contents \\--\n\n| Name   | Size in bytes         |\n|--------|-----------------------|\n| header | 36                    |\n| frames | frames_count \\* frame |\n\n\\-- one frame, size is (bones \\* 12 + 12 + 12) \\--\n\n| Name             | Size                                  |\n|------------------|---------------------------------------|\n| root rotation    | 12 = 3 floats                         |\n| root translation | 12 = 3 floats                         |\n| rotations        | bones \\* 12 bytes = bones \\* 3 floats |\n\nheader structure, 36 bytes\n\n```c\nstructÂ {\nÂ Â Â Â unsignedÂ int32Â version;\nÂ Â Â Â unsignedÂ int32Â frames_count;\nÂ Â Â Â unsignedÂ int32Â bones_count;\nÂ Â Â Â unsignedÂ charÂ rotation_order[3];\nÂ Â Â Â unsignedÂ charÂ unused;\nÂ Â Â Â unsignedÂ int32Â runtime_data[5];\n}Â anim_head;\n```\n\nI understand only two values from the header, \\'frames_count\\' which is number of animation frames and \\'bones_count\\' which is suprisingly number of animated bones.\n\n*version should always be 1 or FF7 will not load the file*\n\n*rotation order determines in which order rotations are applied, 0 means alpha rotation, 1 beta rotation and 2 gamma rotation.*\n\n*runtime data has no meaning in the animation file and is discarded on load*\n\nIf you want to load all possible animations for the model (even animations of different models) then check if animation file has same number of bones as current model.\n\nFrame starts with the root rotations and root translations, followed by rotations for each bone. Rotations are stored as 3 floats (float is 4byte floating-point number).\n\n\n---\n\n<!-- MERGE METADATA\nCreated: 2025-11-29 15:45 JST\nOriginal File: FF7_Field_Module.md (293 lines)\nMajor Section: 05_FIELD_MODULE.md (2,645 lines)\nAdditions: 6 critical sections, ~600 lines\nImages: 1 existing (updated path), 1 referenced but missing\nReport: comparisons/FF7_Field_Module_vs_05_FIELD_MODULE_analysis.md\n-->\n\n## MERGED CONTENT FROM MAJOR SECTION\n\nThe following sections have been extracted from 05_FIELD_MODULE.md and added to expand the technical coverage of the Field Module documentation.\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 74-107 (Section 1 Dialog and Event)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n#### **Section 1 Dialog and Event (Halkun, Lasyan, and Fice)**\n\nThe First section holds the Field Script logic and Dialog data for that particular field file. The first section of the PSX DAT file (excluding the DAT header) and the data in this section are the same. A recap of the PSX DAT file format is later in this document.\n\nThe data in this section also has a header with the following format.\n\n#### Section 1 Header\n\n```\nstruct FF7SCRIPTHEADER {\n u16 unknown1;\n char nEntities; // Number of entities\n u16 unknown2; // Always less than nEntities; possibly visible entities?\n u16 wStringOffset; // Offset to strings\n u16 nExtraOffsets; // An optional number of extra offsets... unknown\n u16 unknown4[4];\n char szCreator[8]; // Field creator (never shown)\n char szName[8]; // Field name (never shown)\n char szEntities[nEntities][8]; // Field entity names\n u32 dwExtraOffsets[nExtraOffsets]; // Said extra offsets... unknown\n u16 vEntityScripts[nEntities][32]; // Entity script entry points, or more\n                                     // explicitly, subroutine offsets\n};\n```\n\n#### Event Script Subsection\n\nHere we have all of the pointers tables, one for each section. Pointers are 2 bytes length. Each table has a length of 64 bytes, which means a section can have 32 scripts max. Each pointer refers to the first command of the current script. The section number N begins at the offset header\\_length+N\\*64. Note: the only way to retrieve the length of a script is to subtract the position of the next script to the position of the current script.\n\n#### Dialog Subsection\n\nRight after the last script of the last section, we find the pointer's table of the dialogs. The first 2 bytes show the number of dialogs in the file, so you can deduct the length of the table: number\\_of\\_dialogs\\*2. After these 2 bytes we have the pointers for each dialog. Be aware that the pointers are relative to the table, which means you must add the position of the table to each pointer in order to find the right position of the dialog. The dialogs begin right after the table, and the code 255 means the end of the dialog.\n\nNote: some <<hidden>> dialogs are not referenced in the table!\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 109-168 (Section 2 Camera Matrix)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n#### **Section 2 Camera Matrix (Kero)**\n\nThis is yet to be completely understand, I am pretty sure that this is not exactly trash, since it is based on at least 300 changes of field files. It was pretty nasty, as you can imagine, first divide sections of field file, load section 2 into hexedit, change byte, save section 2, run .bat file that complete new field file with new section 2 and compress it. After that I always had to use ficedula lgp tools, awful, I am definitely going to program command line program for this, in gui i had to alway on original field file, click, replace, click instead of just adding line to .bat file. After that run ff7.exe, go to destinated location and observe what happened.\n\nI am working on program to load walkmesh along with camera matrix. I am pretty sure about vectors, after all, they are all same length and they are orthogonal, but i could misinterpret order of them, position of center is little uncertain and resize factor too. The program should help me to figure out these thing.\n\n#### Description of section 2 (field file) - camera\n\nGoal of this section is to define camera matrix. In fact it seems pretty simple. For camera matrix, you need vector for axis x, vector for axis y, vector for axis z and position of camera in world space. Vectors for axis x,y,z are defined in world space and in camera space are normally united.\n\nExample: You have axis x defined as vector (0.176,-0.512,0.840) but thats in the world space, in camera space it is just (1,0,0)\n\n- \\* Every offset is relative here, 00 is at the start of section 2 (after length indicator).\n- \\* This will will be in the left handed coordinated system= x axis from left to right, y axis from bottom to top, z axis from near to far.\n- \\* In here, I am changing signs so these vectors should be correct for file loaded right from section 5 walkmesh. While in walkmesh you don't change any signs, here I am changing them, so they will fit and if you use this article with unchanged values for walkmesh, you should get right image , same as in ff7. (FIXME: not yet true)\n\nThis is an overview the camera data format.\n\n#### Section 2 Format\n\n| Offset | Size    | Description             |\n|--------|---------|-------------------------|\n| 0x00   | 6 bytes | Camera Vector X axis    |\n| 0x06   | 6 bytes | Camera Vector Y axis    |\n| 0x0C   | 6 bytes | Camera Vector Z axis    |\n| 0x12   | 2 bytes | Unknown                 |\n| 0x14   | 4 byes  | Camera Space X position |\n| 0x18   | 4 bytes | Camera Space Y position |\n| 0x1C   | 4 bytes | Camera Space Z position |\n| 0x20   | 4 byes  | Unknown                 |\n| 0x24   | 2 bytes | Zoom                    |\n\nHow to get vectors for the axis:\n\nVectors are stored right at the beginning of section 2.\n\n```\ntypedef struct {\nS16 x;\nS16 y;\nS16 z;\n} vector3s;\n```\n\nYou will load first vector for axis x (from offset 0 to 5), for axis y(6 to 11) and axis z (12-17). These values are in fixed point with multiply constant 4096. Length of vectors x,y and z is always 4096 (first vecsize is for x, then y and last z), thats make out multiplication constant. These vectors are also always ortognormal, as you can see in ORTO 1-2 (1=x,2-y,3=z) ORTO U-Vis scalar product of U and V. As you can see, very near zero (first value is without division of multi constant). Now you have three vectors, but they are not looking in correct direction, you have to change some signs. For each vector change sign of y and z values. Now these vectors should point in correct direction, same as in ff7.\n\nI am now suppose that you have vectors for axises loaded, each component of each vector was divided by 4096 (don't forget to store it in float) and you changed signs for component y and z. After vectors is one S16 number (from offset 18 to 19), same as z component of vector for z axis.\n\nNow you want to have position of center of the camera matrix. Get three S32 numbers for position of center (x from 20 to 23, y from 24-27 and z from 28-31). These number are not position of center in worlds pace, but they are position of center of camera space, defined in space, where position of center is in 0,0,0 and axis for vectors are the ones you read, but have opposite signs. You get center of camera matrix like this:\n\n```\n// vx,vy,vz are axis you read, divided, y,z signs changed\n// (tx,ty,tz) is position of camera matrix in world space\n// ox,oy,oz are S32 numbers you read from offset 20 to 31\ntx = -(ox*vx.x + oy*vy.x + oz*vz.x);\nty = -(ox*vx.y + oy*vy.y + oz*vz.y);\ntz = -(ox*vx.z + oy*vy.z + oz*vz.z);\n```\n\nAfter this is just blank U32 number, seems always zero and last, but not least the zoom (36-37) (don't know whether Signed or Unsigned). The bigger resize number is, the bigger is the model and walkmesh.\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 170-204 (Section 4 Palette)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n#### **Section 4 Pallette (Terrence)**\n\nThe following is an overview of the palette data\n\n#### Section 4 Palette Format\n\n| Offset | Size    | Description                               |\n|--------|---------|-------------------------------------------|\n| 0x00   | 2 bytes | Length (Repeat of previous length header) |\n| 0x02   | 2 bytes | Unknown                                   |\n| 0x04   | 1 byte  | Unknown (often blank)                     |\n| 0x05   | 4 byes  | Number of colors in palette               |\n| 0x09   | 1 byte  | Unknown (often blank)                     |\n| 0x0A   | varies  | Palette data                              |\n\nAfter the first length indicator comes another integer, also indicating length. Useless, but it's there.\n\nThen there's one more integer; unknown purpose.\n\nThen one byte; unknown (blank often).\n\nThen a word; number of colors in the palette plus one. No idea why. You can work numcolors out from the section length, but FF7 stores it anyway; why add one? Dunno.\n\nOne more byte; unknown (blank often).\n\nThen the actual palette data.\n\nEach palette entry is a 16-bit color. This is unusual - normally palettes store as high quality data as possible, usually 24/32 bit. However since FF7 only ever runs in 16 bit I guess there isn't much point storing any other kind of data. Actually, the data is 15-bit (5-bit Red, 5-bit Green, 5-bit Blue, and 1 mask bit).\n\n|              | Palette Data |   |   |   |   |   |   |      |      |   |   |   |   |   |   |\n|--------------|--------------|---|---|---|---|---|---|------|------|---|---|---|---|---|---|\n| Red<br>Green |              |   |   |   |   |   |   | Blue | Mask |   |   |   |   |   |   |\n| r            | r            | r | r | r | g | g | g | g    | g    | b | b | b | b | b | m |\n\nThat's it for the palette! Only other thing you need to know is, palettes generally contain a number of colors that's a multiple of 256. This is because the palette is split up into 256-color 'pages' internally. So the first color is page 0/color 0. Color 256 is page 1/color 0. Color 628 is page 2/color 116. You'll see why in the background section.\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 206-254 (Section 5 Walkmesh)\n     Status: Content added verbatim from major section\n     Images: _page_80_Picture_0.jpeg (NOT FOUND - flagged for sourcing)\n-->\n\n#### **Section 5 Walkmesh (Kero)**\n\nEvery every offset is here relative, 00 is at the start of section 5 (after lenght indicator)\n\nSection 5 of field files is stored walkmesh. Walkmesh is mesh of polygons on which is character moving, it is telling engine for example how height it is and thanks to that PC can, for example, cross bridge with real feeling that in the middle he is on higher place than on both sides. It has very simple structure.\n\n#### Header\n\n---------\n\nStartofs 0x00\n\nLenght 0x04\n\nWalkmesh doesn't have header, it as only one 4 bytes long unsigned int, called NoS (Number of sectors)\n\n## Sector pool\n\n```\n--------------\nStartofs 0x04\nLenght NoS*24\ntypedef struct {\nshort x,z,y,res; // short is 2 bytes long integer\n} vertex_3s; // 3 short\ntypedef struct {\nvertex_3d v[3];\n} sect_t;\n```\n\nIn sector pool are sectors, in fact just triangles and its position. For each sector you have three vertex\\_3s. Just store them. It seems that res and z are very often same, but not always, I don't know why. It seems that all polygons are clockwise. I didnt check it, but it is probably in order to know wheather point is in triangle. If you give it in other direction, point will be detected outside if it is inside and vice versa. Nothing difficult\n\n## Access pool\n\nStartofs 0x04 + NoS\\*24 Lenght NoS\\*6 typedef { short acces1,acces2,acces3; } In access pool you have id of poly, you should go into if you cross line.\n\nacces1 is for line from vertex 0 to 1\n\nacces2 is for line from vertex 1 to 2\n\nacces3 is for line from vertex 2 to 0\n\nIf acces1/2/3 is FFFF then you are not allowed to cross this line. Acces pool and sector pool are same size (NoT), so you will just use same index for both pools.\n\nIf access don't translate you, it just says, you should be here, if you are not, then there is a problem. If you design polymesh where you cross line and access tells you that you should be in poly 12, but you are god know where then FF7 stops.\n\n**[IMAGE REFERENCE - MISSING FROM CURRENT DIRECTORY]** Walkmesh polygon diagram (originally _page_80_Picture_0.jpeg)\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 256-277 (Section 7 Encounter Data)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n#### **Section 7 (Terrence)**\n\nAs stated, Section 7 is the Encounter listing, and is generally 48 bytes long (not including the Length dword). I've not even started to decrpyt what the other bytes mean around there... I suspect encounter rates and other things. Each encounter is stored something like: xxxxxxxx yyyyyyxx, where the 'x's are the standard Battle ID we're familiar with, and the 'y's are something connected to that specific encounter. Encounters where you can get ambushed appear to be held seperately from the others, too, starting at... what... 0x14? Unsure.\n\nAnyhow, feel free to play with it. I remain disappointed that this has yielded no trace of Ho-chu in Ancient Forest... was hoping it would at least be some really rare battle or something....\n\nEDIT: Few more notes on the Encounters section.\n\nFirst, \\*EVERY\\* Field file's Encounter section is 48 bytes long (52 if you include the size). It's then split into definite partitions:\n\n0x00: Encounter Data 1, possibly enounter rate in 2nd bytes? (2 bytes) 0x02-0x0D: Encounter+Chance(?) bytes, as stated before. The total of the 'Chance(?)' bytes for this part always adds up to 64 if encounters are possible.\n\n0x0E-0x17: Secondary encounters. Sometimes blank, sometimes gaps. No clue on the chance bytes, or how it relates to previous data.\n\n0x18: Encounter Data 2, same setup as Encounter Data 1. Very often blank, no idea what this data is for.\n\n0x1A-0x25: Encounter+Chance(?) bytes for Encounter Data 2. Again, adds up to 64.\n\n0x26-0x2F: Secondary encounters for Encounter Data 2. Again, no idea what it's used for.\n\nTo get more information, I'm going to have to go and start changing things, but thought you'd like an update on what I had for now.\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 280-429 (Section 9 Background and Sprite Format)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n#### **Section 9 Background (Terrence)**\n\nFirstly, a number of variables.\n\nAt offset \\$28, a Word = background width (BGWidth)\n\nAt offset \\$2A, a Word = background height (BGHeight)\n\nAt offset \\$2C, a Word = number of background sprites (NumBGSprites)\n\nAt offset \\$32, the background sprite data. See below for format (each sprite is 52 bytes long)\n\nAfter the background sprite data, another \\$7 bytes, unknown purpose.\n\nThen (ie. at offset \\$32 + NumBGSprites\\*52 + \\$7) a Word = number of 2nd layer background sprites (NumBG2Sprites)\n\nThen another \\$12 bytes, unknown purpose.\n\nThen (ie. at offset \\$32 + NumBGSprites\\*52 + \\$1B) the background layer 2 sprite data. See below for format.\n\nThen another \\$3D bytes, unknown purpose.\n\nThen (ie. at offset \\$32 + NumBGSprites\\*52 + NumBG2Sprites\\*52 + \\$58) the raw image data.\n\n#### Background paradigm\n\n-------------------\n\n(It isn't \\*really\\* a paradigm, but it sounds impressive if you say it is.)\n\nFF7 stores its backgrounds in a rather complex format. Basically, you have the data split up into various sections:\n\n- 1) Palette. List of colours.\n- 2) Background sprites, layers 1 and 2. Just references to other bits of data.\n- 3) Raw image data. Palettized data (ie. \"grayscale\" if viewed directly).\n\nEach background sprite represents a 16x16 pixel block on the finished background. The sprite essentially contains the following information:\n\n- -\"Target\" block, ie. where on the background to draw this 16x16 square\n- -\"Source\" block, ie. where on the raw image data to take the pixels from\n- -Palette \"page\", ie. which 256-colour palette block to apply to the raw image data\n\nThis is a very efficient way to store the image; on the one hand, it's in 16-bit colour, far better than just palettizing the whole image (ie. 256 colours over the \\*whole\\* background). On the other hand, each 16x16 pixel block takes much less space than if you'd stored it directly in 16-bit colour format. It isn't, however, easy to decode or (especially!) encode.\n\nFormat of a background sprite:\n\n```\nType\n TFF7BgSprite = packed record\n ZZ1,X,Y: Smallint;\n ZZ2: Array[0..1] of Smallint;\n SrcX,SrcY: Smallint;\n ZZ3: Array[0..3] of Smallint;\n Pal: Smallint;\n Flags: Word;\n ZZ4: Array[0..2] of Smallint;\n Page,Sfx: Smallint;\n NA: Longint;\n ZZ5: Smallint;\n OffX,OffY: Longint;\n ZZ6: Smallint;\n end;\n```\n\nZZ1,2,3,4,5,6: Unknown data X,Y: Target position SrcX,SrcY: Source position\n\nPal: Which palette page to use\n\nFlags: Indicate special effects ... not really understood properly.\n\nPage: Which image source page to use\n\nSfx: More special effects?\n\nNA: Unknown OffX,OffY: Unknown\n\nThe image source data is split up into 256x256 pixel pages; that's why as well as a source X and Y, you also have a source page\n\n(which 256x256 block to take data from). On the other hand, the destination background is stored as one big bitmap with no limits on size, so there, you just have a target X/Y position which can be used directly.\n\nAlso, note that each source image data \"page\" is preceded by 6 bytes of header.\n\nSo, say the raw image data starts at offset ImageData. Given a background sprite, the offset where that sprites data starts is:\n\n```\nStartOffset := (Page shl 16) or ((SrcY shl 8) or SrcX) + (Page+1)*6;\nthis is equivalent to\n```\n\nStartOffset := (Page \\* \\$FFFF) + (SrcY \\* \\$FF) + SrcX + (Page+1)\\*6;\n\n(Page shl 16), (Page\\*\\$FFFF): Each page takes up 256x256 = \\$FFFF bytes, so skip that many for each page.\n\n(SrcY shl 8), (SrcY\\*\\$FF): Each pixel row takes up 256 = \\$FF bytes, so skip that many to get to the right row.\n\nSrcX: Taken directly.\n\n(Page+1)\\*6: Skip 6 bytes of header per page. (Page+1) since even page 0 has 6 bytes preceding it.\n\nIncidentally, the shifts are used in preference to multiplication since shifting is more efficient. Shifting on a computer is equivalent to multiplying/dividing by 2, 4, 8, .....\n\nFor the destination, note that you can use X/Y directly; however 0,0 \\*appears\\*, I \\*think\\*, to be at the image \\*centre\\*, not at the top/bottom left corner like with most programs.\n\nSo, now you know:\n\n- -Where the raw image data for that sprite starts\n- -Where you're drawing it to\n- -Which palette page to use\n\nNow, you just copy the pixels across, filtering the palette into it. IE:\n\nRead a pixel from source image (one byte).\n\nSet current colour to that colour in palette.\n\nDraw onto target.\n\nSo, if you read a byte = 55 from the source image, you'd draw colour 55 in the selected palette to the target bitmap.\n\n#### Other points\n\n------------\n\nCurrently, Qhimms (and therefore mine too) source code doesn't draw a sprite if the Sfx is non-zero; this is because we don't understand what it does.\n\nAll variables above (Page, Pal, X, Y) start from ZERO; palette page zero is the first one, page one is the next one, etc.\n\nThe image data in FF7 palettes is stored in reverse order; ie. on Windows, data is stored Red first, then Green, then Blue. FF7\n\nstores it the opposite way around, so you need to exchange the red/blue data. Here's how I do it in Cosmo:\n\n```\n DCol := 0;\n DCol := DCol or ( (Col^ and $1F) shl 10 );\n DCol := DCol or (Col^ and $3E0);\n DCol := DCol or ( (Col^ and $7C00) shr 10);\n```\n\nConverts Col, an FF7 colour, into DCol, a (16-bit) Delphi colour.\n\nThe first background sprites are drawn \"behind\" the layer 2 sprites.\n\nVariable conventions; I'm using Delphi names, which are as follows:\n\nByte: 8 bit, unsigned, integer Word: 16 bit, unsigned, integer Smallint: 16 bit, signed, integer Integer/Longint:32 bit, signed, integer\n\n(Unsigned = positive values only. Signed can hold positive or negative values).\n\nAlso, whenever I use numbers with \\$ signs above, it means I'm using hex values (hexadecimal).\n\n----------------------------\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 2514-2580 (Opcode Matrix and Command Definitions)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n#### Opcode Matrix\n\n|    | 00       | 01           | 02       | 03           | 04      | 05       | 06      | 07       | 08       | 09        | 0a     | 0b       | 0c       | 0d      | 0e     | 0f       |\n|----|----------|--------------|----------|--------------|---------|----------|---------|----------|----------|-----------|--------|----------|----------|---------|--------|----------|\n| 00 | RET      | REQ          | REQSW    | REQEW        | PREQ    | PRQSW    | PRQEW   | RETTO    | JOIN     | SPLIT     | SPTYE  | GTPYE    | ?0C?     | ?0D?    | DSKCG  | SPECIAL  |\n| 10 | GotoNext | GotoNextLong | GotoPrev | GotoPrevLong | IfUByte | IfUByteL | IfSWord | IfSWordL | IfUSWord | IfUSWordL | Â­      | Â­        | ?1C?     | Â­       | Â­      | Â­        |\n| 20 | MINIGAME | TUTOR        | BTMD2    | BTRLD        | wait    | NFADE    | BLINK   | BGMOVIE  | KAWAI    | KAWIW     | PMOVA  | SLIP     | BGPDH    | BGSCR   | WCLS   | WSIZW    |\n| 30 | IFÂ­KEY   | IFÂ­KEYON     | IFÂ­KEYOF | UC           | PDIRA   | PTURA    | WSPCL   | WNUMB    | STTIM    | GOLD+     | GOLDÂ­  | CHGLD    | HMPMAX1  | HMPMAX2 | MHMMX  | HMPMAX3  |\n| 40 | message  | MPARA        | MPRA2    | MPNAM        | Â­       | MP+      | Â­       | MPÂ­      | ASK      | MENU      | MENU2  | BTLTB    | Â­        | HP+     | Â­      | HP       |\n| 50 | window   | WMOVE        | WMODE    | WREST        | WCLSE   | WROW     | GWCOL   | SWCOL    | STÂ­ITM   | DLÂ­ITM    | CKÂ­ITM | SMÂ­TRA   | DMÂ­TRA   | CMÂ­TRA  | SHAKE  | NOP      |\n| 60 | MAPJUMP  | SCRLO        | SCRLC    | SCRLA        | SCR2D   | SCRCC    | SCR2DC  | SCRLW    | SCR2DL   | MPDSP     | VWOFT  | FADE     | FADEW    | IDLCK   | LSTMP  | SCRLP    |\n| 70 | battle   | BTLON        | BTLMD    | PGTDR        | GETPC   | PXYZI    | PLUS!   | PLUS2!   | MINUS!   | MINUS2!   | INC!   | INC2!    | DEC!     | DEC2!   | TLKON  | RDMSD    |\n| 80 | set byte | SETÂ­WORD     | BITÂ­ON   | BITÂ­OFF      | BITÂ­XOR | PLUS     | PLUS2   | MINUS    | MINUS2   | MUL       | MUL2   | DIV      | DIV2     | MOD     | MOD2   | AND      |\n| 90 | AND2     | OR           | OR2      | XOR          | XOR2    | INC      | INC2    | DEC      | DEC2     | RANDOM    | LBYTE  | HBYTE    | 2BYTE    | SETX    | GETX   | SEARCHX  |\n| a0 | PC       | CHAR         | DFANM    | ANIME1       | VISI    | XYZI     | XYI     | XYZ      | MOVE     | CMOVE     | MOVA   | TURA     | ANIMW    | FMOVE   | ANIME2 | ANIM!1   |\n| b0 | CANIM1   | CANM!1       | MSPED    | DIR          | TURNGEN | TURN     | DIRA    | GETDIR   | GETAXY   | GETAI     | ANIM!2 | CANIM2   | CANM!2   | ASPED   | Â­      | CC       |\n| c0 | JUMP     | AXYZ         | LADER    | OFST         | OFSTW   | TALKR    | SLIDR   | SOLID    | PRTYP    | PRTYM     | PRTYE  | IFÂ­PRTYQ | IFÂ­MEMBQ | MMB+Â­   | MMBLK  | MMBUK    |\n| d0 | LINE     | LINON        | MPJPO    | SLINE        | SIN     | COS      | TLKR2   | SLDR2    | PMJMP    | PMJMP2    | AKAO2  | FCFIX    | CCANM    | ANIMB   | TURNW  | MPPAL    |\n| e0 | BGON     | BGOFF        | BGROL    | BGROL2       | BGCLR   | STPAL    | LDPAL   | CPPA     | RTPAL    | ADPAL     | MPPAL2 | STPLS    | LDPLS    | CPPAL2  | RTPAL2 | ADPAL2   |\n| f0 | MUSIC    | Sound        | AKAO     | MUSVT        | MUSVM   | MULCK    | BMUSC   | CHMPH    | PMVIE    | MOVIE     | MVIEF  | MVCAM    | FMUSC    | CMUSC   | CHMST  | GAMEOVER |\n\n#### Opcode Definitions\n\n| Opcode | Name |\n|--------|------|\n| 0x00   | RET  |\n\nArguments: (none)\n\nDescription: Returns control back to the standard program loop. Usually you can control the PC again after this point.\n\n| Opcode | Name |\n|--------|------|\n| 0x01   | REQ  |\n\nArguments: (none)\n\nDescription: Returns control back to the standard program loop. Usually you can control the PC again after this point.\n\n| Opcode    | Name       |\n|-----------|------------|\n| 0x30      | WINDOW     |\n\nArguments:\n- id=byte - Window ID\n\nAdditional Parameters:\n- X coordinate for the upper left hand corner\n- X coordinate for the upper left hand corner\n- Width of window in pixels\n- Height of window in pixels\n\nDescription: Initializes a windowpane. This does not display a window, but allows for a \"container\" for the commands ASK and MESSAGE to place text within. It is referenced by it's window ID\n\n| Opcode       | Name                                      |\n|--------------|-------------------------------------------|\n| 0x48         | ASK                                       |\n\nArguments:\n- unknown=byte - Unknown\n- win=byte - Window ID to place data into\n- mes=byte - Which dialog to display from dialog table\n- 1st=byte - Which line is the first choice\n- nth=byte - Which line is the last choice\n- var=byte - Unknown\n\nDescription: The ASK command opens a window with a set of choices to be picked with the \"selector finger\" (Yubi)\n\n<!-- END EXTRACTION -->\n\n---\n\n## Images\n\n![Field BackgroundVRAM](../images/Field_BackgroundVRAM.jpg)\n\n","numLines":801,"startLine":1,"totalLines":801}}},{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_019MUYtbQK9Pe5wxpxm8YG8d","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check what images exist in the images directory:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":15772,"cache_read_input_tokens":65702,"cache_creation":{"ephemeral_5m_input_tokens":15772,"ephemeral_1h_input_tokens":0},"output_tokens":127,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"2a899fcc-a3fb-4228-a7a9-07367d3df87a"},{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_019MUYtbQK9Pe5wxpxm8YG8d","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0122tfrYcPKCeLTYSdkzjGV2","name":"Bash","input":{"command":"ls -la /Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod/docs/reference/game_engine/images/ | head -40","description":"List available images in images directory"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":15772,"cache_read_input_tokens":65702,"cache_creation":{"ephemeral_5m_input_tokens":15772,"ephemeral_1h_input_tokens":0},"output_tokens":127,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"7001c2da-585c-4bd2-a8fc-403557d22bf9"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0122tfrYcPKCeLTYSdkzjGV2","type":"tool_result","content":"total 1168\ndrwxr-xr-x@ 30 johnzealand-doyle  staff    960 Nov 28 14:48 .\ndrwxr-xr-x@ 82 johnzealand-doyle  staff   2624 Dec  2 00:51 ..\n-rw-r--r--@  1 johnzealand-doyle  staff  36816 Nov 28 14:42 Engine_parts.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  55498 Nov 28 14:42 Field_BackgroundVRAM.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  52674 Nov 28 14:42 Gears_img_3.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff   3744 Nov 28 14:42 Gears_img_4.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff   1820 Nov 28 14:42 Kernel_table.png\n-rw-r--r--@  1 johnzealand-doyle  staff   4152 Nov 28 14:42 Menu_Begin.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  17084 Nov 28 14:42 Menu_Change.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  15384 Nov 28 14:42 Menu_Config.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  30422 Nov 28 14:42 Menu_Equip.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  19594 Nov 28 14:42 Menu_Form.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  15372 Nov 28 14:42 Menu_Item.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff   9806 Nov 28 14:42 Menu_Limit.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  22840 Nov 28 14:42 Menu_Magic.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  13708 Nov 28 14:42 Menu_Name.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  19272 Nov 28 14:42 Menu_Party.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  48604 Nov 28 14:42 Menu_PC_Textures.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  61430 Nov 28 14:42 Menu_PCT_Annotated.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  21498 Nov 28 14:42 Menu_Save.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  21916 Nov 28 14:42 Menu_Shop.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  17434 Nov 28 14:42 Menu_Status.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  38204 Nov 28 14:42 Menu_Windowbin.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff    632 Nov 28 14:42 PSX_color_formats_16.png\n-rw-r--r--@  1 johnzealand-doyle  staff    928 Nov 28 14:42 PSX_color_formats_24.png\n-rw-r--r--@  1 johnzealand-doyle  staff    512 Nov 28 14:42 PSX_color_formats_4.png\n-rw-r--r--@  1 johnzealand-doyle  staff    432 Nov 28 14:42 PSX_color_formats_8.png\n-rw-r--r--@  1 johnzealand-doyle  staff   2340 Nov 28 14:42 PSX_TIM_file_clut.png\n-rw-r--r--@  1 johnzealand-doyle  staff   3168 Nov 28 14:42 PSX_TIM_file_image.png\n-rw-r--r--@  1 johnzealand-doyle  staff   6086 Nov 28 14:42 PSX_TIM_file_layout.png","is_error":false}]},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"dc91712d-9294-48cf-8936-776c44f3f8bf","tool_use_result":{"stdout":"total 1168\ndrwxr-xr-x@ 30 johnzealand-doyle  staff    960 Nov 28 14:48 .\ndrwxr-xr-x@ 82 johnzealand-doyle  staff   2624 Dec  2 00:51 ..\n-rw-r--r--@  1 johnzealand-doyle  staff  36816 Nov 28 14:42 Engine_parts.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  55498 Nov 28 14:42 Field_BackgroundVRAM.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  52674 Nov 28 14:42 Gears_img_3.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff   3744 Nov 28 14:42 Gears_img_4.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff   1820 Nov 28 14:42 Kernel_table.png\n-rw-r--r--@  1 johnzealand-doyle  staff   4152 Nov 28 14:42 Menu_Begin.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  17084 Nov 28 14:42 Menu_Change.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  15384 Nov 28 14:42 Menu_Config.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  30422 Nov 28 14:42 Menu_Equip.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  19594 Nov 28 14:42 Menu_Form.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  15372 Nov 28 14:42 Menu_Item.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff   9806 Nov 28 14:42 Menu_Limit.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  22840 Nov 28 14:42 Menu_Magic.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  13708 Nov 28 14:42 Menu_Name.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  19272 Nov 28 14:42 Menu_Party.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  48604 Nov 28 14:42 Menu_PC_Textures.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  61430 Nov 28 14:42 Menu_PCT_Annotated.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  21498 Nov 28 14:42 Menu_Save.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  21916 Nov 28 14:42 Menu_Shop.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  17434 Nov 28 14:42 Menu_Status.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff  38204 Nov 28 14:42 Menu_Windowbin.jpg\n-rw-r--r--@  1 johnzealand-doyle  staff    632 Nov 28 14:42 PSX_color_formats_16.png\n-rw-r--r--@  1 johnzealand-doyle  staff    928 Nov 28 14:42 PSX_color_formats_24.png\n-rw-r--r--@  1 johnzealand-doyle  staff    512 Nov 28 14:42 PSX_color_formats_4.png\n-rw-r--r--@  1 johnzealand-doyle  staff    432 Nov 28 14:42 PSX_color_formats_8.png\n-rw-r--r--@  1 johnzealand-doyle  staff   2340 Nov 28 14:42 PSX_TIM_file_clut.png\n-rw-r--r--@  1 johnzealand-doyle  staff   3168 Nov 28 14:42 PSX_TIM_file_image.png\n-rw-r--r--@  1 johnzealand-doyle  staff   6086 Nov 28 14:42 PSX_TIM_file_layout.png","stderr":"","interrupted":false,"isImage":false}},{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LwLrD6WQ7FR8LP82fL1LuE","type":"message","role":"assistant","content":[{"type":"text","text":"Good, `Field_BackgroundVRAM.jpg` exists. Now let me check a few other standardized files to ensure I follow the correct patterns:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1367,"cache_read_input_tokens":81474,"cache_creation":{"ephemeral_5m_input_tokens":1367,"ephemeral_1h_input_tokens":0},"output_tokens":144,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"e9a22e33-0d01-49fd-b244-7cc4909cff08"},{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LwLrD6WQ7FR8LP82fL1LuE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EwzZhRfn6Ui5FKwqDg8Eqp","name":"Read","input":{"file_path":"/Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod/docs/reference/game_engine/final/FF7_Kernel.md","limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1367,"cache_read_input_tokens":81474,"cache_creation":{"ephemeral_5m_input_tokens":1367,"ephemeral_1h_input_tokens":0},"output_tokens":144,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"4b1a3316-6220-4d84-b5c4-a4975baca1f9"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EwzZhRfn6Ui5FKwqDg8Eqp","type":"tool_result","content":"     1â†’---\n     2â†’title: \"FF7/Kernel\"\n     3â†’module: \"Kernel\"\n     4â†’created: \"2025-11-28 14:30 JST\"\n     5â†’modified: \"2025-12-02 00:02 JST\"\n     6â†’session_id: \"887a1b3f-e34c-44f4-8434-e7e55610b603\"\n     7â†’author: \"Generated by Claude Code Documentation Standardization Agent\"\n     8â†’status: \"Complete\"\n     9â†’\n    10â†’# LLM-specific metadata (CRITICAL for routing)\n    11â†’llm_summary: \"Documents the KERNEL.BIN archive structure including all 27 data sections for commands, attacks, items, weapons, armor, accessories, materia, and text strings. LLMs should read this when parsing kernel data files, modifying game stats, or understanding FF7's binary data format specifications.\"\n    12â†’llm_tags: [\"kernel\", \"bin-archive\", \"data-format\", \"item-data\", \"weapon-data\", \"materia-data\", \"savemap\"]\n    13â†’llm_primary_topics: [\"KERNEL.BIN section formats\", \"Equipment data structures\", \"Materia attributes\", \"Item restriction masks\", \"Character stat initialization\"]\n    14â†’llm_related_docs: [\"FF7_Kernel_Overview.md\", \"FF7_Kernel_Memory_management.md\", \"FF7_Kernel_Kernelbin.md\", \"FF7_Kernel_Low_level_libraries.md\", \"FF7_Savemap.md\"]\n    15â†’\n    16â†’# Backlinks (leave empty - populated in pass 2)\n    17â†’referenced_by: []\n    18â†’---\n    19â†’\n    20â†’<!--\n    21â†’STANDARDIZATION METADATA\n    22â†’Original: FF7_Kernel.md\n    23â†’Source: merged_with_pdf_content/FF7_Kernel.md\n    24â†’Standardized: 2025-12-02 00:02 JST\n    25â†’Session-ID: 887a1b3f-e34c-44f4-8434-e7e55610b603\n    26â†’Agent: FF7 Documentation Standardization Agent v1.0\n    27â†’\n    28â†’Previous Merge Metadata:\n    29â†’- Original file: FF7_Kernel.md\n    30â†’- Source extraction: 03_KERNEL.md (lines 216-1856 from original 8,167-line file)\n    31â†’- Extraction date: 2025-11-28 14:30 JST\n    32â†’- Content preserved: YES (original content unchanged, new content appended with markers)\n    33â†’\n    34â†’Standardization Changes Applied:\n    35â†’- Added YAML frontmatter with LLM routing metadata\n    36â†’- Added HTML comment metadata block with standardization history\n    37â†’- Converted 4 wiki-style links to standard markdown format\n    38â†’- Verified heading hierarchy: H1â†’H2â†’H3â†’H4 (already correct, no changes needed)\n    39â†’- Removed redundant empty table cells from Section 1 Command Data Format\n    40â†’- Preserved all technical content and table structures exactly\n    41â†’- No images in document (no path standardization needed)\n    42â†’- No code blocks in document (no language tags needed)\n    43â†’\n    44â†’LLM CONTEXT BLOCK (Read this first for routing decisions):\n    45â†’This document is the primary reference for FF7's KERNEL.BIN binary archive format,\n    46â†’which stores all static game data including commands, attacks, items, weapons, armor,\n    47â†’accessories, and materia. Each section has detailed byte-level specifications with\n    48â†’offset tables and flag definitions. Cross-reference with FF7_Savemap.md for runtime\n    49â†’data structures and FF7_Kernel_Low_level_libraries.md for compression/archive formats.\n    50â†’-->\n    51â†’\n    52â†’# FF7/Kernel\n    53â†’\n    54â†’This file contains both the original navigation content and extracted technical documentation from the major section `03_KERNEL.md`.\n    55â†’\n    56â†’## Table of Contents\n    57â†’\n    58â†’- [Kernel Overview](FF7_Kernel_Overview.md)\n    59â†’- [Memory Management](FF7_Kernel_Memory_management.md)\n    60â†’- [Kernel.bin](FF7_Kernel_Kernelbin.md)\n    61â†’- [Low Level Libraries](FF7_Kernel_Low_level_libraries.md)\n    62â†’\n    63â†’---\n    64â†’\n    65â†’## Game Resources - Kernel.BIN Detailed Format Specifications\n    66â†’\n    67â†’### Important Files\n    68â†’\n    69â†’| PSX Version      | PC Version               |\n    70â†’|------------------|--------------------------|\n    71â†’| /INIT/KERNEL.BIN | /DATA/KERNEL/KERNEL.BIN  |\n    72â†’|                  | /DATA/KERNEL/KERNEL2.BIN |\n    73â†’\n    74â†’### The KERNEL.BIN Archive\n    75â†’\n    76â†’The file /INIT/KERNEL.BIN is in BIN-GZIP format. This format is explained later in this document. It consists of 27 gziped sections concatenated together with a 6 byte header for each. This file is the same both on the PC and PSX versions. This holds all the static data and menu text for the game, with a look up table at the beginning of the section. Sections 10-27 are FF Text files.\n    77â†’\n    78â†’The KERNEL.BIN file consists of the following sections.\n    79â†’\n    80â†’| File | Data                          | Offset |\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"2ab309b4-e99b-435f-b744-bffa6d94eff8","tool_use_result":{"type":"text","file":{"filePath":"/Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod/docs/reference/game_engine/final/FF7_Kernel.md","content":"---\ntitle: \"FF7/Kernel\"\nmodule: \"Kernel\"\ncreated: \"2025-11-28 14:30 JST\"\nmodified: \"2025-12-02 00:02 JST\"\nsession_id: \"887a1b3f-e34c-44f4-8434-e7e55610b603\"\nauthor: \"Generated by Claude Code Documentation Standardization Agent\"\nstatus: \"Complete\"\n\n# LLM-specific metadata (CRITICAL for routing)\nllm_summary: \"Documents the KERNEL.BIN archive structure including all 27 data sections for commands, attacks, items, weapons, armor, accessories, materia, and text strings. LLMs should read this when parsing kernel data files, modifying game stats, or understanding FF7's binary data format specifications.\"\nllm_tags: [\"kernel\", \"bin-archive\", \"data-format\", \"item-data\", \"weapon-data\", \"materia-data\", \"savemap\"]\nllm_primary_topics: [\"KERNEL.BIN section formats\", \"Equipment data structures\", \"Materia attributes\", \"Item restriction masks\", \"Character stat initialization\"]\nllm_related_docs: [\"FF7_Kernel_Overview.md\", \"FF7_Kernel_Memory_management.md\", \"FF7_Kernel_Kernelbin.md\", \"FF7_Kernel_Low_level_libraries.md\", \"FF7_Savemap.md\"]\n\n# Backlinks (leave empty - populated in pass 2)\nreferenced_by: []\n---\n\n<!--\nSTANDARDIZATION METADATA\nOriginal: FF7_Kernel.md\nSource: merged_with_pdf_content/FF7_Kernel.md\nStandardized: 2025-12-02 00:02 JST\nSession-ID: 887a1b3f-e34c-44f4-8434-e7e55610b603\nAgent: FF7 Documentation Standardization Agent v1.0\n\nPrevious Merge Metadata:\n- Original file: FF7_Kernel.md\n- Source extraction: 03_KERNEL.md (lines 216-1856 from original 8,167-line file)\n- Extraction date: 2025-11-28 14:30 JST\n- Content preserved: YES (original content unchanged, new content appended with markers)\n\nStandardization Changes Applied:\n- Added YAML frontmatter with LLM routing metadata\n- Added HTML comment metadata block with standardization history\n- Converted 4 wiki-style links to standard markdown format\n- Verified heading hierarchy: H1â†’H2â†’H3â†’H4 (already correct, no changes needed)\n- Removed redundant empty table cells from Section 1 Command Data Format\n- Preserved all technical content and table structures exactly\n- No images in document (no path standardization needed)\n- No code blocks in document (no language tags needed)\n\nLLM CONTEXT BLOCK (Read this first for routing decisions):\nThis document is the primary reference for FF7's KERNEL.BIN binary archive format,\nwhich stores all static game data including commands, attacks, items, weapons, armor,\naccessories, and materia. Each section has detailed byte-level specifications with\noffset tables and flag definitions. Cross-reference with FF7_Savemap.md for runtime\ndata structures and FF7_Kernel_Low_level_libraries.md for compression/archive formats.\n-->\n\n# FF7/Kernel\n\nThis file contains both the original navigation content and extracted technical documentation from the major section `03_KERNEL.md`.\n\n## Table of Contents\n\n- [Kernel Overview](FF7_Kernel_Overview.md)\n- [Memory Management](FF7_Kernel_Memory_management.md)\n- [Kernel.bin](FF7_Kernel_Kernelbin.md)\n- [Low Level Libraries](FF7_Kernel_Low_level_libraries.md)\n\n---\n\n## Game Resources - Kernel.BIN Detailed Format Specifications\n\n### Important Files\n\n| PSX Version      | PC Version               |\n|------------------|--------------------------|\n| /INIT/KERNEL.BIN | /DATA/KERNEL/KERNEL.BIN  |\n|                  | /DATA/KERNEL/KERNEL2.BIN |\n\n### The KERNEL.BIN Archive\n\nThe file /INIT/KERNEL.BIN is in BIN-GZIP format. This format is explained later in this document. It consists of 27 gziped sections concatenated together with a 6 byte header for each. This file is the same both on the PC and PSX versions. This holds all the static data and menu text for the game, with a look up table at the beginning of the section. Sections 10-27 are FF Text files.\n\nThe KERNEL.BIN file consists of the following sections.\n\n| File | Data                          | Offset |","numLines":80,"startLine":1,"totalLines":543}}},{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_017kNtij9iNXWEzkNBkm5A6x","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a good understanding of the expected format. Let me now create the transformed document. I'll prepare the complete standardized document:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1621,"cache_read_input_tokens":82841,"cache_creation":{"ephemeral_5m_input_tokens":1621,"ephemeral_1h_input_tokens":0},"output_tokens":13055,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"198ffef2-5c4e-4817-a491-a444ab7a0ba9"},{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_017kNtij9iNXWEzkNBkm5A6x","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015mXvzrwsEY8KafaGrDqThG","name":"Write","input":{"file_path":"/Volumes/DevSSD/01_Development/Projects/experiments/ff70G-japanese-mod/docs/reference/game_engine/final/FF7_Field_Module.md","content":"---\ntitle: \"FF7/Field Module\"\nmodule: \"Field\"\ncreated: \"2025-11-29 15:45 JST\"\nmodified: \"2025-12-02 01:29 JST\"\nsession_id: \"88731ce4-e57c-4a06-b73f-6569a7b9979e\"\nauthor: \"Generated by Claude Code Documentation Standardization Agent\"\nstatus: \"Complete\"\n\n# LLM-specific metadata (CRITICAL for routing)\nllm_summary: \"Documents FF7's Field Module including file formats (PC/PSX), event scripting system, background rendering, camera matrices, walkmesh collision, and all 9 section formats. LLMs should read this when parsing field files (DAT/MIM/BSX/BCX), implementing field script opcodes, or understanding 2D background layering with 3D overlay systems.\"\nllm_tags: [\"field-module\", \"event-scripting\", \"walkmesh\", \"background-rendering\", \"camera-matrix\", \"psx-format\", \"opcodes\"]\nllm_primary_topics: [\"Field file section formats\", \"Event scripting opcodes\", \"Walkmesh collision system\", \"Background sprite rendering\", \"Camera matrix transformations\", \"Animation file structures\"]\nllm_related_docs: [\"FF7_Engine_basics.md\", \"FF7_Kernel.md\", \"FF7_LZSS_format.md\", \"FF7_Battle_Battle_Scenes.md\", \"FF7_WorldMap_Module.md\"]\n\n# Backlinks (leave empty - populated in pass 2)\nreferenced_by: []\n---\n\n<!--\nSTANDARDIZATION METADATA\nOriginal: FF7_Field_Module.md\nSource: merged_with_pdf_content/FF7_Field_Module.md\nStandardized: 2025-12-02 01:29 JST\nSession-ID: 88731ce4-e57c-4a06-b73f-6569a7b9979e\nAgent: FF7 Documentation Standardization Agent v1.0\n\nPrevious Merge Metadata:\n- Created: 2025-11-29 15:45 JST\n- Original File: FF7_Field_Module.md (293 lines)\n- Major Section: 05_FIELD_MODULE.md (2,645 lines)\n- Additions: 6 critical sections, ~600 lines\n- Images: 1 existing (updated path), 1 referenced but missing\n- Report: comparisons/FF7_Field_Module_vs_05_FIELD_MODULE_analysis.md\n\nStandardization Changes Applied:\n- Added YAML frontmatter with LLM routing metadata\n- Added HTML comment metadata block with standardization history\n- Fixed heading hierarchy: Promoted H4 merged content sections to H3 for proper hierarchy flow\n- Converted 23 wiki-style links to standard markdown format (e.g., {.wikilink} removed)\n- Standardized 1 image path to ../images/ format with descriptive alt text\n- Removed malformed nested image reference (180px-Field_BackgroundVRAM.jpg)\n- Preserved all HTML tables as-is (complex styling requires HTML)\n- Added language tag 'c' to 1 code block (struct definition)\n- Added language tag 'text' to 7 code blocks (data structures and pseudo-code)\n- Removed wiki-style TOC with {#toc-} anchors (replaced with clean markdown)\n- Preserved all technical content including extraction markers\n- Fixed \"Pallette\" typo preserved as-is to maintain original author attribution\n\nLLM CONTEXT BLOCK (Read this first for routing decisions):\nThis document covers FF7's Field Module - the core game module that loads field maps,\nhandles event scripting, renders 2D backgrounds with 3D overlays, and manages character\nmovement via walkmesh collision. The PC version uses a single LZS-compressed file with\n9 sections; PSX uses separate DAT/MIM/BSX/BCX files. Key technical details include\nthe painter's algorithm for background layering, Field Script bytecode with 246 opcodes,\nand camera matrix transformations. Cross-reference with FF7_LZSS_format.md for compression\nand FF7_Engine_basics.md for overall architecture context.\n-->\n\n# FF7/Field Module\n\n## Table of Contents\n\n- [Important Files](#important-files)\n- [Field Overview](#field-overview)\n- [Field Format (PC)](#field-format-pc)\n- [Field Format (PS1)](#field-format-ps1)\n- [Event Scripting](#event-scripting)\n- [Script Commands](#script-commands)\n- [Movies](#movies)\n- [The 3D Overlay](#the-3d-overlay)\n- [Data Organization](#data-organization)\n- [Animation Files](#a-field-animation-files-for-pc-by-mirex-edits-by-aali)\n- [Merged Content from Major Section](#merged-content-from-major-section)\n\n## Important Files\n\n|  PSX Version  |       PC Version       |\n|:-------------:|:----------------------:|\n| /FIELD/\\*.DAT | /DATA/FIELD/FLEVEL.LGP |\n| /FIELD/\\*.MIM | /DATA/FIELD/FLEVEL.LGP |\n| /FIELD/\\*.BSX |                        |\n| /FIELD/\\*.BCX |  /DATA/FIELD/CHAR.LGP  |\n\n## Field Overview\n\nThe field module is the core of the game to which everything else is spawned. It is tied very closely with the kernel and contains many low-level calls to it. The field system also contains a self-contained bytecode language called commonly called \"Field Script\". The field module is responsible for the following:\n\n- The loading and parsing of the field files\n- The display of the 2D background ands related special effects\n- The display of 3D elements in the field such as the camera, perspective and and entities\n- The running of the Field Script to display events and to get user input\n- The on-demand loading of other modules when needed\n\nThe Field module loads modular \"Field Files\". In the PC version, the Field File is a single file with nine sections. In the PSX version, there are three files with the same name but with different extensions that do the same thing. The three files are MIM (Mutiple Image Maps, or the backgrounds), DAT (Field Script Data), and BSX (3D data).\n\n![PSX VRAM snapshot showing background field files in various stages of assembly](../images/Field_BackgroundVRAM.jpg)\n\nThe backgrounds are actually 16x16 blocks that are loaded into VRAM and then assembled into the video buffer every frame. The system allows for layers to obscure the 3D entities using a simple painter's algorithm.\n\nIn this particular field file, there are six cached sections of background data. Also notice the bright green patches that don't show up in in the video buffer. This was to show where a lower layer of 2D data was to be covered by a higher layer. The bright green is for debug purposes. During development, if any bright green showed up, it meant that your upper layer had a \"hole\" in it that a 3D entity could be seen through.\n\nWhen the PSX version of FF7 is ran in higher resolutions via emulation with texture filtering on, often the lower layers will \"bleed\" outside the upper layer and make artifacts. This was also the reason why the field files were not re-rendered for the PC version of the game. It would of required \"re-cutting\" the layers again in the higher resolution.\n\nAnother last thing to note is in the middle of the bottom texture cache there are a sea of eyes. These blink at random times and reflect the random blinking of the characters in the game.\n\n## Field Format (PC)\n\n### General PC Field File Format\n\nField files are always found in FLEVEL.LGP. They are always [LZS](FF7_LZSS_format.md) compressed.\n\nThe first two bytes of each (decompressed) field file are blank (zero). The next four bytes is an integer indicating how many sections are present in the file. Then a number of 4-byte integers follow, giving the starting offset for each section.\n\nAll field files should contain 9 sections; it's what FF7 expects.\n\n### PC Field File Header\n\n<table>\n<thead>\n<tr>\n<th><p>Offset</p></th>\n<th><p>Size</p></th>\n<th><p>Description</p></th>\n<th><p>Section Data</p></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><p>0x00</p></td>\n<td><p>2 bytes</p></td>\n<td><p>Blank</p></td>\n<td><p>Always 0x00</p></td>\n</tr>\n<tr>\n<td><p>0x02</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Number of Sections</p></td>\n<td><p>Always 0x0009</p></td>\n</tr>\n<tr>\n<td><p>0x06</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 1</p></td>\n<td><p>Field Script & Dialog</p></td>\n</tr>\n<tr>\n<td><p>0x0A</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 2</p></td>\n<td><p>Camera Matrix</p></td>\n</tr>\n<tr>\n<td><p>0x0E</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 3</p></td>\n<td><p>Model Loader</p></td>\n</tr>\n<tr>\n<td><p>0x12</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 4</p></td>\n<td><p>Palette</p></td>\n</tr>\n<tr>\n<td><p>0x16</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 5</p></td>\n<td><p>Walkmesh</p></td>\n</tr>\n<tr>\n<td><p>0x1A</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 6</p></td>\n<td><p>TileMap (Unused)</p></td>\n</tr>\n<tr>\n<td><p>0x1E</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 7</p></td>\n<td><p>Encounter</p></td>\n</tr>\n<tr>\n<td><p>0x22</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 8</p></td>\n<td><p>Triggers</p></td>\n</tr>\n<tr>\n<td><p>0x26</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Pointer to Section 9</p></td>\n<td><p>Background</p></td>\n</tr>\n<tr>\n<td><p>0x2A</p></td>\n<td><p>4 bytes</p></td>\n<td><p>Where Pointer to Section 1 points to</p></td>\n<td><p>Length of Section 1</p></td>\n</tr>\n<tr>\n<td><p>0x2E</p></td>\n<td><p>Varies</p></td>\n<td><p>Start of Section 1 data. Continues for the<br />\nnumber of bytes specified in Section Length</p></td>\n<td><p><em>See links above</em></p></td>\n</tr>\n</tbody>\n</table>\n\nEach section generally starts with a four byte integer indicating the length of the section. You could just work this out by comparing offsets (how much space until the next section/end of file, etc) but FF7 stores the length at the start of the section anyway. After that the actual data follows. So the first bit of data for a section is actually 4 bytes after the point given in the section header (since the first four bytes are actually the length marker).\n\nTo examine each section, please navigate using the links in the table above. For sections 3 and 8, there is some information on [the forum](http://forums.qhimm.com/index.php?topic=4358.msg58674#msg58674).\n\n## Field Format (PS1)\n\n### PSX DAT Format\n\nThe PSX script is contained in the DAT file, it is compressed with [LZS compression](FF7_LZSS_format.md). The first 4 bytes of the compressed DAT file is the length of the compressed data starting at address 0x4.\n\nThe header for the DAT file (after it is decompressed), is 28 bytes in size (they are used in the PSX, it's a list of 7 long word values which point to locations in PSX RAM). So for each of these sections are addressable by taking the first memory location subtracting it and adding 28.\n\nThere are 7 sections each corresponding to the first 7 memory locations at the beginning of the file.\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: center; background: rgb(0,155,0);\"><p>Section Name</p></th>\n<th style=\"text-align: center; background: rgb(0,155,0);\"><p>Section Information</p></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Script</p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains conversations, save point interaction etc.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Walkmesh</p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains walkmesh triangles and access info.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>TileMap</p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains the information for the background, animation,<br />\nand static scene objects.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Camera_Matrix</p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains camera info.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Triggers</p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Contains triggers, singles, gateways and so on.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Encounter</p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Battle Encounter information for location.</p></td>\n</tr>\n<tr>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Models</p></td>\n<td style=\"text-align: center; background: rgb(100,155,100);\"><p>Some info about field models.</p></td>\n</tr>\n</tbody>\n</table>\n\n### PSX MIM Format\n\nPart of the PSX background data is contained in the MIM file, it is compressed with [LZS compression](FF7_LZSS_format.md). It consists of palettes (256 color ones) and screen blocks. No data for locating the blocks on the screen is in this file. The MIM file is a truncated TIM file and contains the normal clut location height and width information. This information is directly loaded into the PSX video ram to be decoded by the field module.\n\n### PSX BSX Format\n\nThe Field models are contained in the BSX file, it is compressed with [LZS compression](FF7_LZSS_format.md). FIELD.TDB contains the textures for these models.\n\n### PSX BCX Format\n\nThe individual characters' field models are stored in BCX files. Their textures are also in FIELD.TDB; they are compressed with [LZS compression](FF7_LZSS_format.md).\n\n## Event Scripting\n\nEvent scripting is handled via a series of script commands and entities spawned for the event. The exception to this is the battle event scripting. This is actually a little bit different. Please refer to the Field Script documentation for more information.\n\n## Script Commands\n\nThe event scripting language for FF7 has 246 commands that have a wide array of functions. For a complete listing of the commands, opcodes, arguments and descriptions, please refer to the [opcodes](#opcode-matrix) section below.\n\n## Movies\n\nMovies in FF7 are actually triggered from the Field Script. The F8 PMVIE opcode is first used to set the movie for which the F9 MOVIE opcode is used to play. It is important to remember the MOVIE ID may vary in the PS1 version depending on what disc you are on. The PC movies were encoded using the DUCK (goose?) format and are AVI video files.\n\nThe PS1 movies were encoded using FMV Motion JPEG video files, for the playstation. These files cannot be decode or read directly from the CD disc media because of the Mode 2 format of the files. The files are encoded using ISO Mode 2 which means the sectors are 2302 bytes in length instead of 2048. The video files have interleaved audio (ADPCM format), between video frames and are 320x224 15fps. Video files that have no audio with it actually has empty sectors of space between video frames to prevent the extremely timing sensitive MDEC decoder in the playstation from locking up.\n\n*Cyberman - 14:18, 30 Dec 2006 (CST)*\n\n## The 3D Overlay\n\n*Section placeholder - content to be documented*\n\n## Data Organization\n\n*Section placeholder - content to be documented*\n\n## \"A\" Field Animation Files for PC by Mirex (Edits by Aali)\n\nEach animation file holds one character animation (run, walk or some other). Some characters have more animation files. Animation is set of frames, in each frame are stored bone rotations.\n\n### Animation File Contents\n\n| Name   | Size in bytes         |\n|--------|-----------------------|\n| header | 36                    |\n| frames | frames_count \\* frame |\n\n### One Frame Structure\n\nSize is (bones \\* 12 + 12 + 12)\n\n| Name             | Size                                  |\n|------------------|---------------------------------------|\n| root rotation    | 12 = 3 floats                         |\n| root translation | 12 = 3 floats                         |\n| rotations        | bones \\* 12 bytes = bones \\* 3 floats |\n\n### Header Structure (36 bytes)\n\n```c\nstruct {\n    unsigned int32 version;\n    unsigned int32 frames_count;\n    unsigned int32 bones_count;\n    unsigned char rotation_order[3];\n    unsigned char unused;\n    unsigned int32 runtime_data[5];\n} anim_head;\n```\n\nI understand only two values from the header, 'frames_count' which is number of animation frames and 'bones_count' which is suprisingly number of animated bones.\n\n*version should always be 1 or FF7 will not load the file*\n\n*rotation order determines in which order rotations are applied, 0 means alpha rotation, 1 beta rotation and 2 gamma rotation.*\n\n*runtime data has no meaning in the animation file and is discarded on load*\n\nIf you want to load all possible animations for the model (even animations of different models) then check if animation file has same number of bones as current model.\n\nFrame starts with the root rotations and root translations, followed by rotations for each bone. Rotations are stored as 3 floats (float is 4byte floating-point number).\n\n---\n\n## MERGED CONTENT FROM MAJOR SECTION\n\nThe following sections have been extracted from 05_FIELD_MODULE.md and added to expand the technical coverage of the Field Module documentation.\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 74-107 (Section 1 Dialog and Event)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n### Section 1: Dialog and Event (Halkun, Lasyan, and Fice)\n\nThe First section holds the Field Script logic and Dialog data for that particular field file. The first section of the PSX DAT file (excluding the DAT header) and the data in this section are the same. A recap of the PSX DAT file format is later in this document.\n\nThe data in this section also has a header with the following format.\n\n#### Section 1 Header\n\n```text\nstruct FF7SCRIPTHEADER {\n u16 unknown1;\n char nEntities; // Number of entities\n u16 unknown2; // Always less than nEntities; possibly visible entities?\n u16 wStringOffset; // Offset to strings\n u16 nExtraOffsets; // An optional number of extra offsets... unknown\n u16 unknown4[4];\n char szCreator[8]; // Field creator (never shown)\n char szName[8]; // Field name (never shown)\n char szEntities[nEntities][8]; // Field entity names\n u32 dwExtraOffsets[nExtraOffsets]; // Said extra offsets... unknown\n u16 vEntityScripts[nEntities][32]; // Entity script entry points, or more\n                                     // explicitly, subroutine offsets\n};\n```\n\n#### Event Script Subsection\n\nHere we have all of the pointers tables, one for each section. Pointers are 2 bytes length. Each table has a length of 64 bytes, which means a section can have 32 scripts max. Each pointer refers to the first command of the current script. The section number N begins at the offset header\\_length+N\\*64. Note: the only way to retrieve the length of a script is to subtract the position of the next script to the position of the current script.\n\n#### Dialog Subsection\n\nRight after the last script of the last section, we find the pointer's table of the dialogs. The first 2 bytes show the number of dialogs in the file, so you can deduct the length of the table: number\\_of\\_dialogs\\*2. After these 2 bytes we have the pointers for each dialog. Be aware that the pointers are relative to the table, which means you must add the position of the table to each pointer in order to find the right position of the dialog. The dialogs begin right after the table, and the code 255 means the end of the dialog.\n\nNote: some <<hidden>> dialogs are not referenced in the table!\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 109-168 (Section 2 Camera Matrix)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n### Section 2: Camera Matrix (Kero)\n\nThis is yet to be completely understand, I am pretty sure that this is not exactly trash, since it is based on at least 300 changes of field files. It was pretty nasty, as you can imagine, first divide sections of field file, load section 2 into hexedit, change byte, save section 2, run .bat file that complete new field file with new section 2 and compress it. After that I always had to use ficedula lgp tools, awful, I am definitely going to program command line program for this, in gui i had to alway on original field file, click, replace, click instead of just adding line to .bat file. After that run ff7.exe, go to destinated location and observe what happened.\n\nI am working on program to load walkmesh along with camera matrix. I am pretty sure about vectors, after all, they are all same length and they are orthogonal, but i could misinterpret order of them, position of center is little uncertain and resize factor too. The program should help me to figure out these thing.\n\n#### Description of Section 2 (Field File) - Camera\n\nGoal of this section is to define camera matrix. In fact it seems pretty simple. For camera matrix, you need vector for axis x, vector for axis y, vector for axis z and position of camera in world space. Vectors for axis x,y,z are defined in world space and in camera space are normally united.\n\nExample: You have axis x defined as vector (0.176,-0.512,0.840) but thats in the world space, in camera space it is just (1,0,0)\n\n- \\* Every offset is relative here, 00 is at the start of section 2 (after length indicator).\n- \\* This will will be in the left handed coordinated system= x axis from left to right, y axis from bottom to top, z axis from near to far.\n- \\* In here, I am changing signs so these vectors should be correct for file loaded right from section 5 walkmesh. While in walkmesh you don't change any signs, here I am changing them, so they will fit and if you use this article with unchanged values for walkmesh, you should get right image , same as in ff7. (FIXME: not yet true)\n\nThis is an overview the camera data format.\n\n#### Section 2 Format\n\n| Offset | Size    | Description             |\n|--------|---------|-------------------------|\n| 0x00   | 6 bytes | Camera Vector X axis    |\n| 0x06   | 6 bytes | Camera Vector Y axis    |\n| 0x0C   | 6 bytes | Camera Vector Z axis    |\n| 0x12   | 2 bytes | Unknown                 |\n| 0x14   | 4 byes  | Camera Space X position |\n| 0x18   | 4 bytes | Camera Space Y position |\n| 0x1C   | 4 bytes | Camera Space Z position |\n| 0x20   | 4 byes  | Unknown                 |\n| 0x24   | 2 bytes | Zoom                    |\n\nHow to get vectors for the axis:\n\nVectors are stored right at the beginning of section 2.\n\n```text\ntypedef struct {\nS16 x;\nS16 y;\nS16 z;\n} vector3s;\n```\n\nYou will load first vector for axis x (from offset 0 to 5), for axis y(6 to 11) and axis z (12-17). These values are in fixed point with multiply constant 4096. Length of vectors x,y and z is always 4096 (first vecsize is for x, then y and last z), thats make out multiplication constant. These vectors are also always ortognormal, as you can see in ORTO 1-2 (1=x,2-y,3=z) ORTO U-Vis scalar product of U and V. As you can see, very near zero (first value is without division of multi constant). Now you have three vectors, but they are not looking in correct direction, you have to change some signs. For each vector change sign of y and z values. Now these vectors should point in correct direction, same as in ff7.\n\nI am now suppose that you have vectors for axises loaded, each component of each vector was divided by 4096 (don't forget to store it in float) and you changed signs for component y and z. After vectors is one S16 number (from offset 18 to 19), same as z component of vector for z axis.\n\nNow you want to have position of center of the camera matrix. Get three S32 numbers for position of center (x from 20 to 23, y from 24-27 and z from 28-31). These number are not position of center in worlds pace, but they are position of center of camera space, defined in space, where position of center is in 0,0,0 and axis for vectors are the ones you read, but have opposite signs. You get center of camera matrix like this:\n\n```text\n// vx,vy,vz are axis you read, divided, y,z signs changed\n// (tx,ty,tz) is position of camera matrix in world space\n// ox,oy,oz are S32 numbers you read from offset 20 to 31\ntx = -(ox*vx.x + oy*vy.x + oz*vz.x);\nty = -(ox*vx.y + oy*vy.y + oz*vz.y);\ntz = -(ox*vx.z + oy*vy.z + oz*vz.z);\n```\n\nAfter this is just blank U32 number, seems always zero and last, but not least the zoom (36-37) (don't know whether Signed or Unsigned). The bigger resize number is, the bigger is the model and walkmesh.\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 170-204 (Section 4 Palette)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n### Section 4: Palette (Terrence)\n\nThe following is an overview of the palette data\n\n#### Section 4 Palette Format\n\n| Offset | Size    | Description                               |\n|--------|---------|-------------------------------------------|\n| 0x00   | 2 bytes | Length (Repeat of previous length header) |\n| 0x02   | 2 bytes | Unknown                                   |\n| 0x04   | 1 byte  | Unknown (often blank)                     |\n| 0x05   | 4 byes  | Number of colors in palette               |\n| 0x09   | 1 byte  | Unknown (often blank)                     |\n| 0x0A   | varies  | Palette data                              |\n\nAfter the first length indicator comes another integer, also indicating length. Useless, but it's there.\n\nThen there's one more integer; unknown purpose.\n\nThen one byte; unknown (blank often).\n\nThen a word; number of colors in the palette plus one. No idea why. You can work numcolors out from the section length, but FF7 stores it anyway; why add one? Dunno.\n\nOne more byte; unknown (blank often).\n\nThen the actual palette data.\n\nEach palette entry is a 16-bit color. This is unusual - normally palettes store as high quality data as possible, usually 24/32 bit. However since FF7 only ever runs in 16 bit I guess there isn't much point storing any other kind of data. Actually, the data is 15-bit (5-bit Red, 5-bit Green, 5-bit Blue, and 1 mask bit).\n\n|              | Palette Data |   |   |   |   |   |   |      |      |   |   |   |   |   |   |\n|--------------|--------------|---|---|---|---|---|---|------|------|---|---|---|---|---|---|\n| Red<br>Green |              |   |   |   |   |   |   | Blue | Mask |   |   |   |   |   |   |\n| r            | r            | r | r | r | g | g | g | g    | g    | b | b | b | b | b | m |\n\nThat's it for the palette! Only other thing you need to know is, palettes generally contain a number of colors that's a multiple of 256. This is because the palette is split up into 256-color 'pages' internally. So the first color is page 0/color 0. Color 256 is page 1/color 0. Color 628 is page 2/color 116. You'll see why in the background section.\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 206-254 (Section 5 Walkmesh)\n     Status: Content added verbatim from major section\n     Images: _page_80_Picture_0.jpeg (NOT FOUND - flagged for sourcing)\n-->\n\n### Section 5: Walkmesh (Kero)\n\nEvery every offset is here relative, 00 is at the start of section 5 (after lenght indicator)\n\nSection 5 of field files is stored walkmesh. Walkmesh is mesh of polygons on which is character moving, it is telling engine for example how height it is and thanks to that PC can, for example, cross bridge with real feeling that in the middle he is on higher place than on both sides. It has very simple structure.\n\n#### Header\n\nStartofs 0x00\n\nLenght 0x04\n\nWalkmesh doesn't have header, it as only one 4 bytes long unsigned int, called NoS (Number of sectors)\n\n#### Sector Pool\n\n```text\n--------------\nStartofs 0x04\nLenght NoS*24\ntypedef struct {\nshort x,z,y,res; // short is 2 bytes long integer\n} vertex_3s; // 3 short\ntypedef struct {\nvertex_3d v[3];\n} sect_t;\n```\n\nIn sector pool are sectors, in fact just triangles and its position. For each sector you have three vertex\\_3s. Just store them. It seems that res and z are very often same, but not always, I don't know why. It seems that all polygons are clockwise. I didnt check it, but it is probably in order to know wheather point is in triangle. If you give it in other direction, point will be detected outside if it is inside and vice versa. Nothing difficult\n\n#### Access Pool\n\nStartofs 0x04 + NoS\\*24 Lenght NoS\\*6 typedef { short acces1,acces2,acces3; } In access pool you have id of poly, you should go into if you cross line.\n\nacces1 is for line from vertex 0 to 1\n\nacces2 is for line from vertex 1 to 2\n\nacces3 is for line from vertex 2 to 0\n\nIf acces1/2/3 is FFFF then you are not allowed to cross this line. Acces pool and sector pool are same size (NoT), so you will just use same index for both pools.\n\nIf access don't translate you, it just says, you should be here, if you are not, then there is a problem. If you design polymesh where you cross line and access tells you that you should be in poly 12, but you are god know where then FF7 stops.\n\n**[IMAGE REFERENCE - MISSING FROM CURRENT DIRECTORY]** Walkmesh polygon diagram (originally _page_80_Picture_0.jpeg)\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 256-277 (Section 7 Encounter Data)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n### Section 7: Encounter Data (Terrence)\n\nAs stated, Section 7 is the Encounter listing, and is generally 48 bytes long (not including the Length dword). I've not even started to decrpyt what the other bytes mean around there... I suspect encounter rates and other things. Each encounter is stored something like: xxxxxxxx yyyyyyxx, where the 'x's are the standard Battle ID we're familiar with, and the 'y's are something connected to that specific encounter. Encounters where you can get ambushed appear to be held seperately from the others, too, starting at... what... 0x14? Unsure.\n\nAnyhow, feel free to play with it. I remain disappointed that this has yielded no trace of Ho-chu in Ancient Forest... was hoping it would at least be some really rare battle or something....\n\nEDIT: Few more notes on the Encounters section.\n\nFirst, \\*EVERY\\* Field file's Encounter section is 48 bytes long (52 if you include the size). It's then split into definite partitions:\n\n0x00: Encounter Data 1, possibly enounter rate in 2nd bytes? (2 bytes) 0x02-0x0D: Encounter+Chance(?) bytes, as stated before. The total of the 'Chance(?)' bytes for this part always adds up to 64 if encounters are possible.\n\n0x0E-0x17: Secondary encounters. Sometimes blank, sometimes gaps. No clue on the chance bytes, or how it relates to previous data.\n\n0x18: Encounter Data 2, same setup as Encounter Data 1. Very often blank, no idea what this data is for.\n\n0x1A-0x25: Encounter+Chance(?) bytes for Encounter Data 2. Again, adds up to 64.\n\n0x26-0x2F: Secondary encounters for Encounter Data 2. Again, no idea what it's used for.\n\nTo get more information, I'm going to have to go and start changing things, but thought you'd like an update on what I had for now.\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 280-429 (Section 9 Background and Sprite Format)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n### Section 9: Background (Terrence)\n\nFirstly, a number of variables.\n\nAt offset \\$28, a Word = background width (BGWidth)\n\nAt offset \\$2A, a Word = background height (BGHeight)\n\nAt offset \\$2C, a Word = number of background sprites (NumBGSprites)\n\nAt offset \\$32, the background sprite data. See below for format (each sprite is 52 bytes long)\n\nAfter the background sprite data, another \\$7 bytes, unknown purpose.\n\nThen (ie. at offset \\$32 + NumBGSprites\\*52 + \\$7) a Word = number of 2nd layer background sprites (NumBG2Sprites)\n\nThen another \\$12 bytes, unknown purpose.\n\nThen (ie. at offset \\$32 + NumBGSprites\\*52 + \\$1B) the background layer 2 sprite data. See below for format.\n\nThen another \\$3D bytes, unknown purpose.\n\nThen (ie. at offset \\$32 + NumBGSprites\\*52 + NumBG2Sprites\\*52 + \\$58) the raw image data.\n\n#### Background Paradigm\n\n(It isn't \\*really\\* a paradigm, but it sounds impressive if you say it is.)\n\nFF7 stores its backgrounds in a rather complex format. Basically, you have the data split up into various sections:\n\n- 1) Palette. List of colours.\n- 2) Background sprites, layers 1 and 2. Just references to other bits of data.\n- 3) Raw image data. Palettized data (ie. \"grayscale\" if viewed directly).\n\nEach background sprite represents a 16x16 pixel block on the finished background. The sprite essentially contains the following information:\n\n- -\"Target\" block, ie. where on the background to draw this 16x16 square\n- -\"Source\" block, ie. where on the raw image data to take the pixels from\n- -Palette \"page\", ie. which 256-colour palette block to apply to the raw image data\n\nThis is a very efficient way to store the image; on the one hand, it's in 16-bit colour, far better than just palettizing the whole image (ie. 256 colours over the \\*whole\\* background). On the other hand, each 16x16 pixel block takes much less space than if you'd stored it directly in 16-bit colour format. It isn't, however, easy to decode or (especially!) encode.\n\n#### Background Sprite Format\n\n```text\nType\n TFF7BgSprite = packed record\n ZZ1,X,Y: Smallint;\n ZZ2: Array[0..1] of Smallint;\n SrcX,SrcY: Smallint;\n ZZ3: Array[0..3] of Smallint;\n Pal: Smallint;\n Flags: Word;\n ZZ4: Array[0..2] of Smallint;\n Page,Sfx: Smallint;\n NA: Longint;\n ZZ5: Smallint;\n OffX,OffY: Longint;\n ZZ6: Smallint;\n end;\n```\n\nZZ1,2,3,4,5,6: Unknown data X,Y: Target position SrcX,SrcY: Source position\n\nPal: Which palette page to use\n\nFlags: Indicate special effects ... not really understood properly.\n\nPage: Which image source page to use\n\nSfx: More special effects?\n\nNA: Unknown OffX,OffY: Unknown\n\nThe image source data is split up into 256x256 pixel pages; that's why as well as a source X and Y, you also have a source page\n\n(which 256x256 block to take data from). On the other hand, the destination background is stored as one big bitmap with no limits on size, so there, you just have a target X/Y position which can be used directly.\n\nAlso, note that each source image data \"page\" is preceded by 6 bytes of header.\n\nSo, say the raw image data starts at offset ImageData. Given a background sprite, the offset where that sprites data starts is:\n\n```text\nStartOffset := (Page shl 16) or ((SrcY shl 8) or SrcX) + (Page+1)*6;\nthis is equivalent to\n```\n\nStartOffset := (Page \\* \\$FFFF) + (SrcY \\* \\$FF) + SrcX + (Page+1)\\*6;\n\n(Page shl 16), (Page\\*\\$FFFF): Each page takes up 256x256 = \\$FFFF bytes, so skip that many for each page.\n\n(SrcY shl 8), (SrcY\\*\\$FF): Each pixel row takes up 256 = \\$FF bytes, so skip that many to get to the right row.\n\nSrcX: Taken directly.\n\n(Page+1)\\*6: Skip 6 bytes of header per page. (Page+1) since even page 0 has 6 bytes preceding it.\n\nIncidentally, the shifts are used in preference to multiplication since shifting is more efficient. Shifting on a computer is equivalent to multiplying/dividing by 2, 4, 8, .....\n\nFor the destination, note that you can use X/Y directly; however 0,0 \\*appears\\*, I \\*think\\*, to be at the image \\*centre\\*, not at the top/bottom left corner like with most programs.\n\nSo, now you know:\n\n- -Where the raw image data for that sprite starts\n- -Where you're drawing it to\n- -Which palette page to use\n\nNow, you just copy the pixels across, filtering the palette into it. IE:\n\nRead a pixel from source image (one byte).\n\nSet current colour to that colour in palette.\n\nDraw onto target.\n\nSo, if you read a byte = 55 from the source image, you'd draw colour 55 in the selected palette to the target bitmap.\n\n#### Other Points\n\nCurrently, Qhimms (and therefore mine too) source code doesn't draw a sprite if the Sfx is non-zero; this is because we don't understand what it does.\n\nAll variables above (Page, Pal, X, Y) start from ZERO; palette page zero is the first one, page one is the next one, etc.\n\nThe image data in FF7 palettes is stored in reverse order; ie. on Windows, data is stored Red first, then Green, then Blue. FF7\n\nstores it the opposite way around, so you need to exchange the red/blue data. Here's how I do it in Cosmo:\n\n```text\n DCol := 0;\n DCol := DCol or ( (Col^ and $1F) shl 10 );\n DCol := DCol or (Col^ and $3E0);\n DCol := DCol or ( (Col^ and $7C00) shr 10);\n```\n\nConverts Col, an FF7 colour, into DCol, a (16-bit) Delphi colour.\n\nThe first background sprites are drawn \"behind\" the layer 2 sprites.\n\nVariable conventions; I'm using Delphi names, which are as follows:\n\nByte: 8 bit, unsigned, integer Word: 16 bit, unsigned, integer Smallint: 16 bit, signed, integer Integer/Longint:32 bit, signed, integer\n\n(Unsigned = positive values only. Signed can hold positive or negative values).\n\nAlso, whenever I use numbers with \\$ signs above, it means I'm using hex values (hexadecimal).\n\n<!-- END EXTRACTION -->\n\n---\n\n<!-- EXTRACTED FROM MAJOR SECTION: 05_FIELD_MODULE.md\n     Lines 2514-2580 (Opcode Matrix and Command Definitions)\n     Status: Content added verbatim from major section\n     Images: None\n-->\n\n### Opcode Matrix\n\n|    | 00       | 01           | 02       | 03           | 04      | 05       | 06      | 07       | 08       | 09        | 0a     | 0b       | 0c       | 0d      | 0e     | 0f       |\n|----|----------|--------------|----------|--------------|---------|----------|---------|----------|----------|-----------|--------|----------|----------|---------|--------|----------|\n| 00 | RET      | REQ          | REQSW    | REQEW        | PREQ    | PRQSW    | PRQEW   | RETTO    | JOIN     | SPLIT     | SPTYE  | GTPYE    | ?0C?     | ?0D?    | DSKCG  | SPECIAL  |\n| 10 | GotoNext | GotoNextLong | GotoPrev | GotoPrevLong | IfUByte | IfUByteL | IfSWord | IfSWordL | IfUSWord | IfUSWordL | Â­      | Â­        | ?1C?     | Â­       | Â­      | Â­        |\n| 20 | MINIGAME | TUTOR        | BTMD2    | BTRLD        | wait    | NFADE    | BLINK   | BGMOVIE  | KAWAI    | KAWIW     | PMOVA  | SLIP     | BGPDH    | BGSCR   | WCLS   | WSIZW    |\n| 30 | IFÂ­KEY   | IFÂ­KEYON     | IFÂ­KEYOF | UC           | PDIRA   | PTURA    | WSPCL   | WNUMB    | STTIM    | GOLD+     | GOLDÂ­  | CHGLD    | HMPMAX1  | HMPMAX2 | MHMMX  | HMPMAX3  |\n| 40 | message  | MPARA        | MPRA2    | MPNAM        | Â­       | MP+      | Â­       | MPÂ­      | ASK      | MENU      | MENU2  | BTLTB    | Â­        | HP+     | Â­      | HP       |\n| 50 | window   | WMOVE        | WMODE    | WREST        | WCLSE   | WROW     | GWCOL   | SWCOL    | STÂ­ITM   | DLÂ­ITM    | CKÂ­ITM | SMÂ­TRA   | DMÂ­TRA   | CMÂ­TRA  | SHAKE  | NOP      |\n| 60 | MAPJUMP  | SCRLO        | SCRLC    | SCRLA        | SCR2D   | SCRCC    | SCR2DC  | SCRLW    | SCR2DL   | MPDSP     | VWOFT  | FADE     | FADEW    | IDLCK   | LSTMP  | SCRLP    |\n| 70 | battle   | BTLON        | BTLMD    | PGTDR        | GETPC   | PXYZI    | PLUS!   | PLUS2!   | MINUS!   | MINUS2!   | INC!   | INC2!    | DEC!     | DEC2!   | TLKON  | RDMSD    |\n| 80 | set byte | SETÂ­WORD     | BITÂ­ON   | BITÂ­OFF      | BITÂ­XOR | PLUS     | PLUS2   | MINUS    | MINUS2   | MUL       | MUL2   | DIV      | DIV2     | MOD     | MOD2   | AND      |\n| 90 | AND2     | OR           | OR2      | XOR          | XOR2    | INC      | INC2    | DEC      | DEC2     | RANDOM    | LBYTE  | HBYTE    | 2BYTE    | SETX    | GETX   | SEARCHX  |\n| a0 | PC       | CHAR         | DFANM    | ANIME1       | VISI    | XYZI     | XYI     | XYZ      | MOVE     | CMOVE     | MOVA   | TURA     | ANIMW    | FMOVE   | ANIME2 | ANIM!1   |\n| b0 | CANIM1   | CANM!1       | MSPED    | DIR          | TURNGEN | TURN     | DIRA    | GETDIR   | GETAXY   | GETAI     | ANIM!2 | CANIM2   | CANM!2   | ASPED   | Â­      | CC       |\n| c0 | JUMP     | AXYZ         | LADER    | OFST         | OFSTW   | TALKR    | SLIDR   | SOLID    | PRTYP    | PRTYM     | PRTYE  | IFÂ­PRTYQ | IFÂ­MEMBQ | MMB+Â­   | MMBLK  | MMBUK    |\n| d0 | LINE     | LINON        | MPJPO    | SLINE        | SIN     | COS      | TLKR2   | SLDR2    | PMJMP    | PMJMP2    | AKAO2  | FCFIX    | CCANM    | ANIMB   | TURNW  | MPPAL    |\n| e0 | BGON     | BGOFF        | BGROL    | BGROL2       | BGCLR   | STPAL    | LDPAL   | CPPA     | RTPAL    | ADPAL     | MPPAL2 | STPLS    | LDPLS    | CPPAL2  | RTPAL2 | ADPAL2   |\n| f0 | MUSIC    | Sound        | AKAO     | MUSVT        | MUSVM   | MULCK    | BMUSC   | CHMPH    | PMVIE    | MOVIE     | MVIEF  | MVCAM    | FMUSC    | CMUSC   | CHMST  | GAMEOVER |\n\n### Opcode Definitions\n\n| Opcode | Name |\n|--------|------|\n| 0x00   | RET  |\n\nArguments: (none)\n\nDescription: Returns control back to the standard program loop. Usually you can control the PC again after this point.\n\n| Opcode | Name |\n|--------|------|\n| 0x01   | REQ  |\n\nArguments: (none)\n\nDescription: Returns control back to the standard program loop. Usually you can control the PC again after this point.\n\n| Opcode    | Name       |\n|-----------|------------|\n| 0x30      | WINDOW     |\n\nArguments:\n- id=byte - Window ID\n\nAdditional Parameters:\n- X coordinate for the upper left hand corner\n- X coordinate for the upper left hand corner\n- Width of window in pixels\n- Height of window in pixels\n\nDescription: Initializes a windowpane. This does not display a window, but allows for a \"container\" for the commands ASK and MESSAGE to place text within. It is referenced by it's window ID\n\n| Opcode       | Name                                      |\n|--------------|-------------------------------------------|\n| 0x48         | ASK                                       |\n\nArguments:\n- unknown=byte - Unknown\n- win=byte - Window ID to place data into\n- mes=byte - Which dialog to display from dialog table\n- 1st=byte - Which line is the first choice\n- nth=byte - Which line is the last choice\n- var=byte - Unknown\n\nDescription: The ASK command opens a window with a set of choices to be picked with the \"selector finger\" (Yubi)\n\n<!-- END EXTRACTION -->\n\n---\n\n## Images\n\n![PSX VRAM snapshot showing background field files in various stages of assembly](../images/Field_BackgroundVRAM.jpg)\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1621,"cache_read_input_tokens":82841,"cache_creation":{"ephemeral_5m_input_tokens":1621,"ephemeral_1h_input_tokens":0},"output_tokens":13055,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"7a1c2966-74ba-4cf8-be66-dc821ddcb178"},{"type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_015mXvzrwsEY8KafaGrDqThG"}]},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"057a8982-b748-498c-a112-29cc122d8086","tool_use_result":"Error: File has not been read yet. Read it first before writing to it."},{"type":"assistant","message":{"id":"62b039de-35ed-474e-8b73-e31c5be59147","container":null,"model":"<synthetic>","role":"assistant","stop_reason":"stop_sequence","stop_sequence":"","type":"message","usage":{"input_tokens":0,"output_tokens":0,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":null,"cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":0}},"content":[{"type":"text","text":"5-hour limit reached Â· resets 5am (Asia/Tokyo) Â· /upgrade to Max 20x or turn on /extra-usage"}],"context_management":null},"parent_tool_use_id":null,"session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","uuid":"151354ac-6266-4c8c-8ea7-f48f2b9cd129","error":"rate_limit"},{"type":"result","subtype":"success","is_error":true,"duration_ms":321695,"duration_api_ms":325640,"num_turns":5,"result":"5-hour limit reached Â· resets 5am (Asia/Tokyo) Â· /upgrade to Max 20x or turn on /extra-usage","session_id":"88731ce4-e57c-4a06-b73f-6569a7b9979e","total_cost_usd":0.9087480000000001,"usage":{"input_tokens":2,"cache_creation_input_tokens":54509,"cache_read_input_tokens":259970,"output_tokens":13455,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":54509}},"modelUsage":{"claude-haiku-4-5-20251001":{"inputTokens":1579,"outputTokens":157,"cacheReadInputTokens":0,"cacheCreationInputTokens":19501,"webSearchRequests":0,"costUSD":0.026740250000000004,"contextWindow":200000},"claude-sonnet-4-5-20250929":{"inputTokens":3,"outputTokens":74,"cacheReadInputTokens":0,"cacheCreationInputTokens":19690,"webSearchRequests":0,"costUSD":0.0749565,"contextWindow":200000},"claude-opus-4-5-20251101":{"inputTokens":2,"outputTokens":13455,"cacheReadInputTokens":259970,"cacheCreationInputTokens":54509,"webSearchRequests":0,"costUSD":0.80705125,"contextWindow":200000}},"permission_denials":[],"uuid":"d3337a83-fa55-41a9-ac14-816c354e6159"}]
